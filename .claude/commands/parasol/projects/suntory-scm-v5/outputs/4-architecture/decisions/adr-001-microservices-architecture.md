# ADR-001: マイクロサービスアーキテクチャの採用

## ステータス
承認済み（2025-01-15）

## コンテキスト

サントリーホールディングスのSCM（サプライチェーンマネジメント）システムは、以下の要件を持つ：

1. **多様なドメイン**: 需要予測、輸送計画、倉庫管理、食品安全、トレーサビリティ、水資源管理、環境報告、受注管理など、異なる専門性を持つ8つのドメイン
2. **異なるスケーラビリティ要件**: 受注処理は繁忙期（年末年始、お中元/お歳暮）に500 orders/minまで急増、一方で環境報告は月次バッチ中心
3. **独立したチーム体制**: 品質保証本部、サステナビリティ推進部、SCM運用部など、異なる部門が各ドメインを担当
4. **外部システム連携**: traevo（輸配送計画）、日立協創システム（ブロックチェーン）、SAP ERP、WMS、EDIなど多数の外部システムとの統合が必要
5. **段階的な刷新**: 既存システムからの段階的な移行が必要

## 決定

**8つのマイクロサービスによる分散アーキテクチャを採用する。**

### サービス一覧

| サービス名 | ドメインタイプ | 責務 |
|-----------|--------------|------|
| Demand Planning Service | Core | 需要予測・販売計画 |
| Transport Planning Service | Core | 輸配送計画・CO2最適化 |
| Order Service | Core | 受注管理・EDI連携 |
| Warehouse Service | VCI | 倉庫管理・在庫制御 |
| Food Safety Service | VCI | HACCP管理・品質検査 |
| Traceability Service | VCI | ロット追跡・ブロックチェーン連携 |
| Water Sustainability Service | Supporting | 水資源管理・涵養記録 |
| Environmental Reporting Service | Generic | CO2計算・ESG報告 |

### サービス境界の決定原則

1. **Bounded Contextの尊重**: DDDに基づき、各サービスは明確なドメイン境界を持つ
2. **チーム構造との整合**: Conway's Lawに従い、組織構造とサービス境界を一致させる
3. **独立デプロイ可能性**: 各サービスは独立してデプロイ・スケール可能
4. **データ所有権の明確化**: 各サービスは自身のデータストアを所有

## 結果

### 良い影響

1. **独立したスケーリング**: 受注サービスは繁忙期に6レプリカまで拡張、環境報告は2レプリカで十分
2. **技術選択の自由度**: 需要予測はPython/MLパイプライン、受注処理はJava/Spring Boot等、最適な技術を選択可能
3. **障害分離**: 1サービスの障害が他に波及しにくい設計
4. **独立したリリースサイクル**: 各チームが独自のペースでリリース可能
5. **段階的移行**: モノリスからの段階的な機能切り出しが可能

### トレードオフ

1. **分散システムの複雑性**: ネットワーク障害、データ整合性の管理が必要
2. **運用オーバーヘッド**: 8つのサービスの監視・運用が必要
3. **サービス間通信のレイテンシ**: 同期呼び出しでのレイテンシ増加
4. **トランザクション管理**: 分散トランザクションをSagaパターンで管理する必要

### リスク

1. **過度な細分化**: サービスが小さすぎると通信オーバーヘッドが増大
   - 軽減策: CL3（詳細能力）単位ではなく、BC単位でサービスを定義
2. **データ一貫性**: 結果整合性の管理が複雑化
   - 軽減策: イベント駆動アーキテクチャとSagaパターンの採用

## 代替案

### 代替案1: モノリシックアーキテクチャ
- **メリット**: シンプル、トランザクション管理が容易
- **却下理由**: 異なるスケーラビリティ要件、チーム間の独立性確保が困難

### 代替案2: サービス指向アーキテクチャ（SOA）
- **メリット**: エンタープライズサービスバスによる統合
- **却下理由**: ESBがボトルネック化、疎結合の実現が困難

### 代替案3: より細かいマイクロサービス（15サービス以上）
- **メリット**: より細かい独立性
- **却下理由**: 運用オーバーヘッドが大きい、チーム規模に対して過剰

## 関連

- ADR-002: イベントバスの選択
- ADR-003: Database per Service パターン
- ADR-004: Saga Choreography パターン
- Context Map: `outputs/4-architecture/context-map.md`
- サービス定義: `outputs/4-architecture/services/`

---

**作成者**: Parasol V5 Phase 4
**レビュー者**: アーキテクチャチーム
