# ビジネスオペレーションとユースケースの階層構造

## 概念の違いと階層関係

パラソルフレームワークでは、以下の階層構造で設計を整理します：

1. **サービス** (Service)
2. **ビジネスケーパビリティ** (Business Capability) - 「XXXする能力」
3. **ビジネスオペレーション** (Business Operation) - ハイレベルユースケース
4. **Actor UseCase** (Actor UseCase) - 単一ユーザの完結操作（実装単位）
5. **ロバストネス図** (Robustness Diagram) - BCE要素の定義 (**NEW**)
6. **View定義** (View Definition) - UI/UX定義
7. **テスト定義** (Test Definition) - テストケース定義

## 完全な階層構造図
```
サービス
└── ビジネスケーパビリティ（複数）
    └── ビジネスオペレーション群（ケーパビリティに関連）
        └── Actor UseCase群（オペレーションを実現）
            ├── ロバストネス図（Actor UseCase毎に1対1）
            ├── View定義群
            └── テスト定義群
```

## ディレクトリ構造
```
docs/parasol/services/[service-name]/
└── capabilities/
    └── [capability-name]/
        └── operations/
            └── [operation-name]/
                ├── operation.md                    # ビジネスオペレーション定義
                ├── actor-usecases/                 # Actor UseCase群
                │   ├── [auc-1-name]/
                │   │   ├── actor-usecase.md       # Actor UseCase定義
                │   │   ├── robustness.md          # ロバストネス図（NEW）
                │   │   └── views/                 # View定義群
                │   │       ├── [view-1-name].md
                │   │       └── [view-2-name].md
                │   └── [auc-2-name]/
                │       ├── actor-usecase.md
                │       ├── robustness.md          # ロバストネス図（NEW）
                │       └── views/
                │           └── [view-3-name].md
                └── tests/                          # テスト定義群（オプション）
                    ├── [test-1-name].md
                    └── [test-2-name].md
```

## ビジネスオペレーション（ハイレベルユースケース）

ビジネスオペレーションは、**ビジネス価値を生み出す一連の活動**を表現します。

### 特徴
- **ビジネス成果にフォーカス**（技術的な詳細ではない）
- **複数のアクターが協調**して価値を生み出す
- **開始から完了まで**の明確なゴールがある
- **測定可能なビジネス価値**を生む

### 例
| ビジネスオペレーション | 説明 |
|----------------------|------|
| 顧客オンボーディング | 新規顧客を獲得し、サービス利用開始まで導く一連の活動 |
| 商品企画・投入 | 市場ニーズを捉えた商品を企画し、市場に投入するまでの活動 |
| 問題解決・改善提案 | 顧客の課題を分析し、解決策を提案・実行する活動 |
| リスク評価・対策立案 | プロジェクトリスクを評価し、対策を立案・実行する活動 |

## Actor UseCase（単一ユーザの完結操作）

Actor UseCaseは、ビジネスオペレーションを**具体的なシステム利用シナリオ**に分解したものです。

### 特徴
- **特定のアクターの視点**で記述
- **システムとの相互作用**を詳細に定義
- **前提条件と事後条件**が明確
- **基本フロー・代替フロー・例外フロー**を含む
- **各フローをMermaid図で可視化**（重要）

### フロー定義の仕様

ユースケースのフローは、テキストによる説明とMermaid図の両方で表現します。

#### 1. 基本フロー
正常系のシナリオをステップバイステップで記述し、Mermaid図で可視化します。

**Markdown形式**:
```markdown
### 基本フロー

\`\`\`mermaid
graph TD
    A[開始] --> B[ステップ1]
    B --> C[ステップ2]
    C --> D[ステップ3]
    D --> E[完了]
\`\`\`

1. [アクター]が[アクション]を実行する
2. システムが[処理]を行う
3. システムが[結果]を表示する
```

#### 2. 代替フロー
条件分岐による別シナリオを記述し、分岐ロジックをMermaid図で可視化します。

**Markdown形式**:
```markdown
### 代替フロー1: [条件の説明]

\`\`\`mermaid
graph TD
    A[分岐点] --> B{条件判定}
    B -->|条件A| C[代替処理]
    B -->|条件B| D[基本フロー続行]
    C --> E[基本フローに復帰]
\`\`\`

- **分岐点**: 基本フロー ステップX
- **条件**: [分岐条件の詳細]

1. システムが[条件]を検知する
2. システムが[代替処理]を実行する
3. 基本フロー ステップYに進む
```

#### 3. 例外フロー
エラーや例外処理のシナリオを記述し、エラーハンドリングをMermaid図で可視化します。

**Markdown形式**:
```markdown
### 例外フロー1: [エラー条件の説明]

\`\`\`mermaid
graph TD
    A[エラー発生点] --> B{エラー種別}
    B -->|回復可能| C[エラーメッセージ表示]
    B -->|回復不可| D[システムエラー]
    C --> E[再試行]
    D --> F[ユースケース終了]
\`\`\`

- **発生点**: 基本フロー ステップX
- **条件**: [エラー発生条件]

1. システムが[エラー]を検知する
2. システムが[エラーメッセージ]を表示する
3. [対処方法]
```

### フロー記述のベストプラクティス

1. **各フローに対応するMermaid図を必ず作成**
   - 基本フロー、代替フロー、例外フローのそれぞれに図を用意
   - 図とテキストの内容が一致していること

2. **Mermaid図は簡潔に**
   - 主要なステップのみを図示（詳細はテキストで補足）
   - 複雑な場合は複数の図に分割

3. **条件分岐は明確に**
   - 菱形（`{}`）を使用して判定ポイントを表現
   - 分岐の条件をラベルで明記

4. **テキストとの対応**
   - Mermaid図のノード名とテキストのステップを対応させる
   - 「ステップX」として参照できるようにする

### 例：「顧客オンボーディング」を分解すると

1. **アカウント作成** (Actor UseCase)
   - アクター：新規顧客
   - 前提条件：メールアドレスを持っている
   - 基本フロー：情報入力→検証→アカウント生成
   - 代替フロー：既存アカウントの場合の処理
   - Mermaid図：基本フロー、代替フロー（既存アカウント）、例外フロー（検証エラー）

2. **本人確認実施** (Actor UseCase)
   - アクター：新規顧客、コンプライアンス担当
   - 前提条件：アカウントが作成済み
   - 基本フロー：書類アップロード→審査→承認/却下
   - Mermaid図：基本フロー、代替フロー（書類不備）、例外フロー（審査タイムアウト）

3. **初期設定支援** (Actor UseCase)
   - アクター：新規顧客、カスタマーサポート
   - 前提条件：本人確認完了
   - 基本フロー：設定ガイド表示→設定実行→完了確認
   - Mermaid図：基本フロー、代替フロー（カスタマイズ設定）

## 判断基準

| 観点 | ビジネスオペレーション | Actor UseCase |
|------|---------------------|-------------|
| **スコープ** | ビジネスプロセス全体 | 単一のシステム操作 |
| **アクター** | 複数（顧客、スタッフ、システム） | 主に1〜2名 |
| **期間** | 数日〜数週間 | 数分〜数時間 |
| **成果** | ビジネス価値（売上、顧客満足度） | タスク完了 |
| **記述レベル** | What（何を達成するか） | How（どう実現するか） |

---

## アジャイル開発との対応関係

### 階層マッピング

パラソルの設計階層は、アジャイル開発のバックログ項目と以下のように対応します：

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃              パラソル設計階層 → アジャイル対応                              ┃
┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫
┃                                                                             ┃
┃  ビジネスオペレーション     ──→     Epic / Feature                         ┃
┃  （複数アクターの協調活動）        （大きなビジネス価値の単位）             ┃
┃           │                                                                 ┃
┃           ▼                                                                 ┃
┃  Actor UseCase             ──→     User Story ★                            ┃
┃  （単一ユーザの完結操作）          （1スプリントで完了可能な価値単位）      ┃
┃           │                                                                 ┃
┃           ▼                                                                 ┃
┃  View                      ──→     Task                                     ┃
┃  （UI画面実装）                    （実装タスク）                           ┃
┃                                                                             ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

### Actor UseCase = User Story の理由

Actor UseCaseがアジャイルのユーザーストーリーに最適な理由：

| 観点 | Actor UseCase | User Story (INVEST原則) |
|------|---------------|------------------------|
| **粒度** | 単一ユーザの完結操作 | 1スプリントで完了可能 (Small) |
| **価値** | ユーザーにとって意味のある成果 | ユーザー価値を提供 (Valuable) |
| **独立性** | 他と独立して実装・テスト可能 | 独立して開発可能 (Independent) |
| **見積可能** | 明確な範囲と完了条件 | 見積もり可能 (Estimable) |
| **テスト可能** | 基本/代替/例外フローで検証可能 | 受け入れ基準が明確 (Testable) |
| **交渉可能** | スコープ調整可能 | 優先度調整可能 (Negotiable) |

### ストーリー形式への変換

Actor UseCaseは自然にユーザーストーリー形式に変換できます：

**Actor UseCase定義**:
```markdown
# Actor UseCase: アカウント作成

- アクター: 新規顧客
- 前提条件: メールアドレスを持っている
- 基本フロー: 情報入力→検証→アカウント生成
- 成果: アカウント作成完了
```

**ユーザーストーリー形式**:
```
As a 新規顧客,
I want to アカウントを作成したい,
So that サービスを利用開始できる.

受け入れ基準:
- メールアドレスで登録できる
- パスワードは8文字以上
- 登録完了メールが届く
```

### 例：「顧客オンボーディング」のアジャイル分解

**Epic**: 顧客オンボーディング（ビジネスオペレーション）
```
複数スプリントにまたがる大きなビジネス価値
```

**User Stories**（Actor UseCase）:
| Actor UseCase | User Story | ストーリーポイント目安 |
|---------------|------------|----------------------|
| アカウント作成 | 「新規顧客として、アカウントを作成したい」 | 3-5pt |
| 本人確認実施 | 「新規顧客として、本人確認を完了したい」 | 5-8pt |
| 初期設定支援 | 「新規顧客として、初期設定を完了したい」 | 3-5pt |

**Tasks**（View実装など）:
| View | Task | 見積もり |
|------|------|---------|
| アカウント作成フォームView | フォームUI実装 | 4h |
| アカウント作成フォームView | バリデーション実装 | 2h |
| 本人確認書類アップロードView | ファイルアップロード実装 | 6h |
| 初期設定ウィザードView | ステップUI実装 | 4h |

### スプリント計画での活用

```
Sprint N:
┌─────────────────────────────────────────────────────────────┐
│ Epic: 顧客オンボーディング (進行中)                          │
│                                                             │
│ ✅ User Story: アカウント作成                                │
│    └── Task: アカウント作成フォームView (完了)               │
│                                                             │
│ 🔄 User Story: 本人確認実施                                  │
│    ├── Task: 書類アップロードView (進行中)                   │
│    └── Task: 審査結果View (未着手)                           │
│                                                             │
│ ⏸️ User Story: 初期設定支援 (次スプリント)                   │
└─────────────────────────────────────────────────────────────┘
```

### イテレーション単位

**重要**: パラソルでは **Actor UseCase（= User Story）** をイテレーション（スプリント）の基本単位として推奨します。

```
イテレーション = 1つ以上の Actor UseCase を完成させる

完成の定義 (DoD):
├── Actor UseCase定義 完了
├── View定義 完了
├── ロバストネス図 完了
├── 実装 完了
├── テスト（Unit/Integration/UI） 合格
└── レビュー 承認
```

### ビジネスオペレーションとの違い（重要）

**ビジネスオペレーション ≠ ユースケース**

ビジネスオペレーションはEpic/Featureレベルであり、ユースケース（Actor UseCase）ではありません：

| 概念 | 定義 | アジャイル対応 | 期間 |
|------|------|---------------|------|
| **ビジネスオペレーション** | ビジネス価値を生む一連の活動 | Epic / Feature | 複数スプリント |
| **Actor UseCase** | 単一ユーザの完結操作 | User Story | 1スプリント内 |

ビジネスオペレーションは「何を達成するか」を定義し、Actor UseCaseは「どう実現するか」を定義します。この階層の違いを理解することで、適切な粒度でバックログを構成できます。

## パターン分類

ビジネスオペレーションは以下のパターンに分類されます：

- **CRUD**: 基本的なデータ管理（作成・参照・更新・削除）
- **Workflow**: 複数ステップの承認・処理フロー
- **Analytics**: 分析・レポーティング・意思決定支援
- **Communication**: コミュニケーション・コラボレーション
- **Administration**: システム管理・設定・メンテナンス

---

## テスト階層との対応

### 設計層とテスト層のマッピング

```
設計階層                          テスト階層
─────────────────────────────────────────────────────────────
サービス
└── ビジネスケーパビリティ
    └── ビジネスオペレーション ──→ E2Eテスト（シナリオ）     5%
        └── Actor UseCase ──────→ 統合テスト（フロー）      15%
            ├── View定義 ──────→ UIテスト（コンポーネント） 15%
            └── (API連携) ─────→ APIテスト（契約）          15%

パラソルドメイン言語 ────────────→ ユニットテスト（ドメイン） 50%
```

### 各テスト層の詳細

| テスト層 | ソース | 責務 | 自動生成 |
|---------|--------|------|---------|
| **E2Eテスト** | ビジネスオペレーション定義 | 複数アクター協調・ビジネス価値達成 | 低 |
| **統合テスト** | Actor UseCase定義（フロー） | 基本/代替/例外フローの完走 | 中 |
| **UIテスト** | View定義 + ロバストネス図 | 表示・操作・BCE連携 | 中 |
| **APIテスト** | API仕様 | エンドポイント契約・入出力検証 | 高 |
| **ユニットテスト** | パラソルドメイン言語 | Aggregate/VO/Service検証 | 高 |

### テスト定義の配置

```
docs/parasol/services/[service-name]/
└── capabilities/
    └── [capability-name]/
        └── operations/
            └── [operation-name]/
                ├── operation.md
                ├── actor-usecases/
                │   └── [auc-name]/
                │       ├── actor-usecase.md
                │       ├── robustness.md
                │       ├── views/
                │       │   └── [view].md
                │       └── tests/                    # Actor UseCase単位テスト
                │           ├── integration.yaml     # @parasol:test_actor_usecase
                │           └── ui.yaml              # @parasol:test_ui
                └── tests/                           # オペレーション単位テスト
                    └── e2e.yaml                     # @parasol:test_business_operation
```

### テスト生成フロー

```
Phase 5: Software Design
    │
    ├── パラソルドメイン言語 ──→ Unit Test Skeleton 自動生成
    │
    ├── API仕様 ─────────────→ API Contract Test 自動生成
    │
    ├── View定義 ────────────→ UI Component Test Skeleton 生成
    │
    └── Actor UseCaseフロー ─→ Integration Test Skeleton 生成

Phase 6: Implementation
    │
    └── テスト実装 + 実行 + カバレッジ検証
```

### 品質ゲート基準

| テスト層 | カバレッジ | 通過率 | 実行タイミング |
|---------|-----------|--------|---------------|
| ユニット | 80%+ | 100% | 毎コミット |
| API | 100%（全エンドポイント） | 100% | 毎コミット |
| UI | 100%（主要View） | 95%+ | 毎コミット |
| 統合 | 基本100%/代替90%/例外80% | 95%+ | 毎PR |
| E2E | 100%（主要シナリオ） | 100% | リリース前 |

### 関連テンプレート

- [テスト定義形式仕様](./_templates/test-definition-format.md) - 各テスト層のYAML形式詳細
- [構造化MD形式仕様](./_templates/structured-md-format.md) - パラソルドメイン言語形式
- [ケイパビリティ・BC・テスト構造](./capability-bc-test-structure.md) - 階層構造の整合性定義