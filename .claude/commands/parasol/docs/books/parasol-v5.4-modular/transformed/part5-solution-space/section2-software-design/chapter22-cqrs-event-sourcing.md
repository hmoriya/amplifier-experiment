# 第22章　CQRSとイベントソーシング ― 時を刻む設計

## はじめに：帆船の航海日誌から学ぶ

1492年、クリストファー・コロンブスは大西洋横断の航海に出ました。彼の船には、すべての出来事を記録する航海日誌がありました。

```
10月11日 22時：陸地の灯火を確認
10月12日 02時：パロス号が陸地発見の合図
10月12日 朝：上陸、新大陸到達
```

航海日誌は「今の位置」を記録するのではなく、「何が起きたか」を記録しました。なぜでしょう？

理由は簡単です。出来事の連続から、いつでも現在の位置を導き出せるからです。さらに重要なことに、なぜその位置にいるのか、どのような決定がなされたのか、すべての文脈が保存されます。

現代のソフトウェアも同じです。「状態」を保存するより「出来事」を記録する方が、はるかに豊かな情報を保持できるのです。

## 第1節：読むことと書くことの違い

### 図書館の知恵

大きな図書館を想像してください。

**本を借りる人（読む人）**は：
- すぐに目的の本を見つけたい
- ジャンル別、著者別、人気順など、様々な方法で探したい
- おすすめの本も知りたい

**司書（書く人）**は：
- 正確に貸出・返却を記録したい
- 本の状態を管理したい
- 規則に従って処理したい

同じ「図書館システム」でも、読む側と書く側では全く異なるニーズがあります。

### CQRSという発想

CQRS（Command Query Responsibility Segregation）は、この「読み」と「書き」を分離する設計パターンです。

```
従来のアプローチ：
┌─────────────────┐
│   同じモデル    │←── 読み取り（検索、表示）
│  （CRUD操作）   │←── 書き込み（更新、削除）
└─────────────────┘
        ↓
   妥協の産物
   
CQRSアプローチ：
┌─────────────────┐     ┌─────────────────┐
│  書き込みモデル  │     │  読み取りモデル  │
│（ビジネスロジック）│     │ （表示に最適化） │
└─────────────────┘     └─────────────────┘
        ↓                        ↓
   それぞれに最適化            用途別に複数可
```

### 実世界の例：レストランのオペレーション

高級レストランの裏側を見てみましょう。

**注文を受ける（コマンド側）**：
```
ウェイター：Table 5、本日のコース2名様
　　↓
注文票に記載（正確性重視）
　　↓
キッチンへ伝票を回す（ルールに従う）
```

**メニューを見せる（クエリ側）**：
```
美しいメニュー表（見やすさ重視）
　├─ 前菜（写真付き）
　├─ メイン（アレルギー表示付き）
　└─ デザート（カロリー表示付き）
```

同じ「料理情報」でも、注文処理とメニュー表示では全く異なる形式が最適なのです。

## 第2節：出来事を記録する理由

### 銀行口座の例

あなたの銀行口座を考えてみましょう。

**状態だけを保存する方式**：
```
現在の残高：50,000円
```

**出来事を記録する方式**：
```
4月1日：給料振込 +200,000円
4月3日：家賃引落 -80,000円
4月5日：ATM出金 -20,000円
4月7日：カード決済 -50,000円
現在の残高：50,000円（計算結果）
```

どちらが有用でしょうか？

### イベントソーシングの価値

イベントソーシング（Event Sourcing）は、すべての変更を「出来事」として記録します。

**メリット**：
1. **完全な履歴** - いつ、何が、なぜ起きたか
2. **時間旅行** - 任意の時点の状態を再現可能
3. **監査証跡** - すべての変更が追跡可能
4. **デバッグ** - 問題の原因を特定しやすい
5. **ビジネス分析** - 行動パターンの分析が可能

### ビジネスにおける実例

**Amazonの注文システム**を想像してください：

```
イベントの流れ：
1. 商品をカートに追加
2. 配送先を選択
3. 支払い方法を選択
4. 注文確定
5. 在庫確保
6. 決済処理
7. 出荷準備
8. 配送開始
9. 配達完了
```

各ステップが「イベント」として記録されることで：
- お客様は注文の現在位置を確認できる
- カスタマーサービスは問題を調査できる
- ビジネス側は各段階の所要時間を分析できる

## 第3節：CQRSとイベントソーシングの組み合わせ

### 最強のコンビネーション

CQRSとイベントソーシングを組み合わせると、非常に強力なアーキテクチャが生まれます。

```
ユーザーアクション
      ↓
   コマンド
      ↓
ビジネスロジック実行
      ↓
   イベント発生 ──→ イベントストア（真実の源）
      ↓                    ↓
      ↓              プロジェクション
      ↓                    ↓
  書き込み完了      読み取りモデル更新
                           ↓
                    ユーザーへの表示
```

### オンラインショッピングでの適用例

**商品の値下げ**というシナリオで見てみましょう：

**1. コマンド側の処理**：
```
店長：商品Xを20%値下げ
　↓
UpdatePriceCommand発行
　↓
ビジネスルールチェック：
- 最低利益率を確保できるか？
- 値下げ幅は妥当か？
　↓
ProductPriceUpdatedイベント発生
```

**2. イベントの記録**：
```
{
  eventType: "ProductPriceUpdated",
  productId: "X",
  oldPrice: 10000,
  newPrice: 8000,
  reason: "期間限定セール",
  updatedBy: "manager-123",
  timestamp: "2024-03-15T10:30:00Z"
}
```

**3. 読み取りモデルの更新**：
```
商品カタログビュー → 新価格を表示
価格履歴ビュー → 値下げを記録
在庫管理ビュー → （変更なし）
売上分析ビュー → 価格変更をマーク
```

各ビューは目的に応じて最適化されています。

## 第4節：実装の勘所

### いつ使うべきか

CQRSとイベントソーシングが適している場面：

**✅ 適している**：
- 複雑なビジネスロジックがある
- 完全な監査証跡が必要
- 読み取りと書き込みの特性が大きく異なる
- 複数の読み取りビューが必要
- 時系列分析が重要

**❌ 適さない**：
- シンプルなCRUDアプリケーション
- リアルタイム性が極めて重要
- チームがパターンに不慣れ
- 小規模で変更の少ないシステム

### 段階的な導入

すべてを一度に変える必要はありません：

**第1段階：部分的なCQRS**
```
重要な機能だけ読み書きを分離
例：注文処理は分離、商品マスタは従来通り
```

**第2段階：重要なイベントの記録**
```
ビジネス的に重要なイベントから記録開始
例：注文、支払い、キャンセル
```

**第3段階：本格的な適用**
```
システム全体でパターンを適用
プロジェクションの自動化
イベント駆動アーキテクチャへ
```

## 第5節：よくある課題と解決策

### 課題1：結果整合性

**問題**：
書き込み直後に読み取ると、まだ反映されていない可能性がある。

**解決策**：
- UIで「処理中」を適切に表現
- 重要な操作後は確認画面を挟む
- 必要に応じて同期的な更新も併用

### 課題2：イベントストアの肥大化

**問題**：
すべてのイベントを保存すると、データ量が膨大になる。

**解決策**：
- スナップショット（定期的な状態保存）
- 古いイベントのアーカイブ
- イベントの集約

### 課題3：スキーマの進化

**問題**：
イベントの形式が変わったらどうする？

**解決策**：
- イベントのバージョニング
- アップキャスト（古い形式を新しい形式に変換）
- 後方互換性の維持

## まとめ：時を超える設計

航海日誌から始まった私たちの旅は、現代のソフトウェア設計にたどり着きました。

CQRSとイベントソーシングは：
- **読み書きの分離**で、それぞれに最適な設計を実現
- **出来事の記録**で、豊かな情報と柔軟性を獲得
- **時間の概念**を、自然にシステムに組み込む

これらは銀の弾丸ではありません。しかし、適切な場面で使えば、複雑なビジネス要求に応える強力な武器となります。

重要なのは、なぜこのパターンを使うのか、という目的を明確にすることです。技術のための技術ではなく、ビジネス価値を生み出すための設計選択として。

### 次章への架橋

高度な設計パターンを理解したところで、次はこれらを確実に実装するためのテスト戦略について学びましょう。複雑なシステムほど、適切なテストが重要になります。

---

## 演習問題

1. **概念理解**：あなたの身の回りで「状態」より「出来事」を記録した方が良いものを3つ挙げ、その理由を説明してください。

2. **設計練習**：図書館システムで、本の貸出・返却をCQRSパターンで設計してください。コマンド側とクエリ側で、それぞれどんな情報が必要か整理しましょう。

3. **トレードオフ分析**：ECサイトの「在庫管理」機能について、従来のCRUD方式とCQRS+イベントソーシング方式のメリット・デメリットを比較してください。

---

## 参考資料

実装の詳細については[付録: CQRS・イベントソーシング実装ガイド](../../appendices/chapter22-implementation.md)を参照してください。