# 第17章　アーキテクチャパターンの選択 ― 都市計画のように設計する

## はじめに：都市計画としてのアーキテクチャ

東京、ニューヨーク、パリ。世界の大都市は、それぞれ独自の「建築様式」を持っています。東京は鉄道網を中心とした放射状の発展、ニューヨークは格子状の区画整理、パリは広い並木道と統一された建築高。これらの都市計画は、その土地の歴史、文化、そして解決すべき課題に応じて進化してきました。

ソフトウェアアーキテクチャも同じです。マイクロサービスは独立した区画を持つ近代都市、モノリスは城壁に囲まれた中世都市、サーバーレスは必要に応じて現れる仮設都市のようなものです。適切なアーキテクチャパターンの選択は、システムの将来を左右する重要な「都市計画」なのです。

## 都市計画の基本原則

### 住民（ユーザー）を第一に考える

優れた都市計画は、そこに住む人々の生活を中心に設計されます。同様に、アーキテクチャパターンの選択も、システムを使う人々と作る人々のニーズから始まります。

**住民のニーズを理解する質問：**
- この「都市」には何人の住民（ユーザー）が住むのか？
- 彼らの生活パターン（利用パターン）はどのようなものか？
- 将来的にどのような成長（スケーリング）が予想されるか？
- どのようなインフラ（技術基盤）が必要か？

### 地形（制約）に合わせた設計

山岳地帯に平野の都市計画を適用することはできません。同様に、技術的制約、組織的制約、ビジネス制約という「地形」を無視したアーキテクチャは失敗します。

**地形を読む観点：**
- **技術的地形**：既存システム、技術スタック、インフラ制限
- **組織的地形**：チーム構造、スキルセット、文化
- **ビジネス地形**：市場要求、競争環境、規制要件

## 主要な都市計画パターン

### モノリシック：城壁都市

中世の城壁都市のように、すべての機能が一つの境界内に収められています。

**特徴：**
- 統一された統治（単一のコードベース）
- 効率的な内部通信（関数呼び出し）
- 外部との明確な境界（統一されたAPI）

**適している場合：**
- 小〜中規模の「人口」（ユーザー数）
- 明確で安定した要件
- 単一チームでの開発
- シンプルな運用を重視

**城壁都市の発展法則：**
人口が増えすぎると、城壁内では収まらなくなります。その時が、次の都市形態への移行を考える時期です。

### マイクロサービス：近代都市の区画整理

ニューヨークのような区画整理された近代都市。各区画（サービス）は独自の機能を持ち、道路（API）でつながっています。

**特徴：**
- 独立した区画（サービスの自律性）
- 専門化された地区（単一責任の原則）
- 発達した交通網（サービス間通信）

**適している場合：**
- 大規模な「人口」と複雑な「生活パターン」
- 複数の独立したチーム
- 異なる成長速度を持つ機能
- 高い可用性とスケーラビリティ要求

**区画整理の原則：**
1. **自然な境界で分ける**：ビジネスケイパビリティに基づく分割
2. **交通の便を考える**：過度な通信が必要な機能は同じ区画に
3. **将来の拡張を見込む**：各区画に成長の余地を残す

### イベント駆動：流動的な市場都市

中東のバザールのように、イベント（市の開催）に応じて形を変える流動的な都市。

**特徴：**
- 疎結合な構造（出店者は独立）
- イベントベースの活動（市の開催で人が集まる）
- 柔軟な拡張（新しい出店者の追加が容易）

**適している場合：**
- リアルタイム性が重要
- 多様なデータソースとコンシューマー
- 非同期処理が主体
- 柔軟な統合が必要

### サーバーレス：遊牧民のキャンプ

必要な時に必要な場所に現れ、不要になれば消える遊牧民のキャンプのような形態。

**特徴：**
- オンデマンドな存在（使用時のみリソース消費）
- 最小限の常設インフラ
- 環境への適応力（自動スケーリング）

**適している場合：**
- 不規則な負荷パターン
- イベント処理が中心
- 運用コストの最小化が重要
- 短時間の処理が主体

## 都市の融合：ハイブリッドアーキテクチャ

現実の都市が単一の計画原理で成り立つことは稀です。東京も、丸の内のビジネス街、浅草の下町、渋谷の商業地区など、異なる特性を持つ地域が共存しています。

### ゾーニングの考え方

**コアビジネス地区**（マイクロサービス）
- 収益を生む中核機能
- 頻繁な更新が必要
- 複数チームが関与

**統合ハブ**（イベント駆動）
- 各地区をつなぐ交通の要所
- 情報の流通と変換
- 疎結合の実現

**郊外機能**（サーバーレス）
- 周辺的な機能
- 使用頻度が低い
- コスト効率重視

**歴史地区**（レガシーシステム）
- 既存の資産
- 段階的な modernization
- Strangler Figパターンで徐々に更新

## パターン選択の決定プロセス

### 1. 都市の将来像を描く

まず、3-5年後のシステムの姿を想像します：
- 予想される「人口」（ユーザー数）は？
- どのような「産業」（ビジネス機能）が発展するか？
- どのような「文化」（開発文化）を育てたいか？

### 2. 現在の状況を評価する

現状の正確な把握なしに、適切な計画は立てられません：
- 現在の「人口」と「インフラ」
- 既存の「建築物」（システム）の状態
- 利用可能な「資源」（予算、人材、時間）

### 3. 移行経路を設計する

一夜にして都市は変わりません。段階的な移行計画が必要です：
- **Phase 1**: 基盤整備（3ヶ月）- CI/CD、監視、ログ基盤
- **Phase 2**: パイロット地区（6ヶ月）- 最初のマイクロサービス
- **Phase 3**: 本格展開（12ヶ月）- 段階的な移行

### 4. 成功指標を定める

都市計画の成功を測る明確な指標：
- **住民の満足度**：ユーザー満足度、応答時間
- **経済効率**：運用コスト、開発速度
- **持続可能性**：保守性、拡張性

## アーキテクチャ決定の文書化

### 都市計画図書の作成

優れた都市計画は、詳細な図書として文書化されます。アーキテクチャ決定記録（ADR）も同様です。

**ADRに含めるべき要素：**
1. **背景と課題**：なぜこの都市計画が必要か
2. **検討した選択肢**：他にどのような可能性があったか
3. **決定とその理由**：なぜこのパターンを選んだか
4. **予想される影響**：良い面と課題の両方
5. **成功の測定方法**：どうやって成否を判断するか

## 進化し続ける都市

都市は生き物です。時代とともに変化し、成長し、時には衰退します。アーキテクチャも同じように、継続的な見直しと調整が必要です。

### 健全な進化のサイン
- 新機能の追加が容易
- パフォーマンスが安定
- チームの生産性が向上
- 運用コストが予測可能

### 再計画が必要なサイン
- 頻繁なシステム障害
- 新機能の追加が困難
- チーム間の調整コスト増大
- 技術的負債の蓄積

## まとめ：持続可能な都市を目指して

アーキテクチャパターンの選択は、一度きりの決定ではありません。都市が成長し変化するように、システムも進化します。重要なのは：

1. **住民（ユーザー）中心の設計**：技術のための技術ではない
2. **地形（制約）への適応**：理想と現実のバランス
3. **段階的な発展**：革命より進化
4. **継続的な見直し**：固定観念にとらわれない
5. **文書化と共有**：決定の透明性

次章では、この都市の中の「自治区」にあたる境界づけられたコンテキストについて、詳しく探求していきます。都市全体の計画ができたら、次は各地区の詳細な設計に入る時です。

---

## 演習問題

1. **都市分析演習**：あなたの組織の現在のシステムを都市に例えると、どのような形態ですか？その「都市」の良い点と課題を分析してください。

2. **将来都市設計**：3年後のシステムの理想的な「都市像」を描いてください。現在からそこに至るまでの「都市開発計画」を立案してください。

3. **ハイブリッド設計**：ECサイトを例に、コア機能はマイクロサービス、周辺機能はサーバーレス、統合層はイベント駆動という「ハイブリッド都市」の設計図を作成してください。

これらの演習を通じて、アーキテクチャパターンを単なる技術選択ではなく、生きたシステムの「都市計画」として捉える視点を養ってください。