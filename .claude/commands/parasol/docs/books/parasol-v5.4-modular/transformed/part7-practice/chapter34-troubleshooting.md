# 第34章　トラブルシューティング ― 救急診療室での戦い

## はじめに：深夜2時の緊急コール

携帯電話が鳴る。深夜2時。「システムダウンです！」

まるで救急診療室に運び込まれた重症患者。症状は「応答なし」、バイタルサインは「エラー500」、そして時間との戦いが始まります。

優秀な救急医が患者を診断するように、システムエンジニアも症状から原因を突き止め、適切な治療を施さなければなりません。本章では、システムの「診察」から「治療」、そして「予防」までの技法を学びます。

---

## 読者別ガイド

**エグゼクティブの方へ** 💼
- インシデントのビジネス影響（5分）
- 予防投資のROI
- リスク管理戦略

**アーキテクトの方へ** 🏗️
- システム診断の体系的アプローチ
- 問題パターンの分類と対策
- 予防的アーキテクチャ

**開発者の方へ** 💻
- 実践的なデバッグテクニック
- ツールの使い方
- インシデント対応手順

---

## 第1章：トリアージ ― 問題の優先順位付け

### 救急診療室の原則

救急診療室では、最も重症な患者から治療します。システムも同じです。

**重症度分類**：

**クリティカル（赤タグ）** 🔴
- 症状：本番環境完全停止
- 影響：全ユーザー
- 対応：即座に全員招集

**高（黄タグ）** 🟡
- 症状：部分的な機能停止
- 影響：一部ユーザー
- 対応：オンコールチーム対応

**中（緑タグ）** 🟢
- 症状：パフォーマンス低下
- 影響：ユーザー体験の劣化
- 対応：計画的な調査

**低（白タグ）** ⚪
- 症状：軽微なエラー
- 影響：限定的
- 対応：通常業務で対応

### バイタルサインのチェック

医師が患者の脈拍、血圧、体温を確認するように、システムの基本的な健康状態を確認します。

**システムのバイタルサイン**：
1. **CPU使用率**（脈拍）
2. **メモリ使用量**（血圧）
3. **レスポンスタイム**（反射神経）
4. **エラー率**（体温）
5. **スループット**（血流量）

---

## 第2章：診断 ― 原因の特定

### 問診：症状の聞き取り

「いつから調子が悪いですか？」
「どんな症状ですか？」
「何か変わったことをしましたか？」

システムでも同じ質問をします：
- **いつから**：タイムライン分析
- **どんな症状**：エラーログ調査
- **何か変更**：デプロイ履歴確認

### 検査：データの収集

**血液検査（ログ分析）**：
システムの「血液」であるログを分析します。エラーメッセージ、警告、異常なパターンを探します。

**レントゲン（メトリクス分析）**：
システムの「骨格」を可視化します。CPU、メモリ、ネットワーク、ディスクの状態を時系列で確認。

**MRI（分散トレーシング）**：
複雑な内部構造を詳細に調査。リクエストがシステム内をどう流れたかを追跡します。

### 診断技法：5つのWhy

医師が症状から病気を特定するように、「なぜ？」を5回繰り返して根本原因を探ります。

**例：Webサイトが遅い**
1. なぜ遅い？ → レスポンスタイムが10秒かかっている
2. なぜ10秒？ → データベースクエリが遅い
3. なぜクエリが遅い？ → インデックスが効いていない
4. なぜインデックスが効かない？ → テーブルが巨大化している
5. なぜ巨大化？ → 古いデータの削除処理が動いていない

**根本原因**：データ削除バッチの障害

---

## 第3章：治療 ― 問題の解決

### 応急処置：止血と安定化

重症患者にはまず止血と安定化が必要です。

**システムの応急処置**：
1. **負荷分散**：健全なサーバーへトラフィックを誘導
2. **機能制限**：重要でない機能を一時停止
3. **キャッシュ活用**：データベース負荷を軽減
4. **スケールアウト**：リソースの追加

### 根本治療：原因の除去

応急処置後、根本的な治療を行います。

**外科手術（コード修正）**：
バグのあるコードを「摘出」し、健全なコードに「移植」します。

**投薬治療（設定変更）**：
パラメーター調整という「薬」で症状を改善します。

**リハビリ（パフォーマンスチューニング）**：
システムが正常に動作するよう、段階的に負荷を上げていきます。

---

## 第4章：カルテ ― 記録と共有

### インシデントレポート

医師がカルテを書くように、インシデントの詳細を記録します。

**カルテの内容**：
```yaml
インシデント番号: INC-2024-0315
発生日時: 2024-03-15 02:00 JST
重症度: クリティカル

症状:
  - API応答なし
  - 全ユーザー影響

診断:
  - メモリリーク
  - OOMKiller発動

治療:
  - 応急: インスタンス再起動
  - 根本: メモリリーク修正

経過:
  02:00 - アラート発生
  02:05 - 診断開始
  02:15 - 応急処置実施
  02:30 - サービス復旧
  03:00 - 根本対策実施

予後:
  - 再発リスク: 低
  - 要経過観察: 48時間
```

### ポストモーテム：症例検討会

医療の世界では、重要な症例について検討会を開きます。システムでも同じです。

**検討内容**：
1. **何が起きたか**（症状と経過）
2. **なぜ起きたか**（根本原因）
3. **どう対応したか**（治療内容）
4. **何がうまくいったか**（成功要因）
5. **何を改善すべきか**（今後の対策）

**重要**：「犯人探し」ではなく「学習機会」として扱う

---

## 第5章：予防医学 ― 問題の未然防止

### 健康診断：定期的なチェック

人間ドックのように、システムも定期的な健康診断が必要です。

**日次検診**：
- ログのエラーパターン分析
- パフォーマンストレンド確認
- リソース使用率チェック

**週次精密検査**：
- 脆弱性スキャン
- 依存関係の更新確認
- バックアップテスト

**月次総合診断**：
- 災害復旧訓練
- キャパシティプランニング
- アーキテクチャレビュー

### 予防接種：耐障害性の向上

ワクチンのように、小さな「感染」でシステムを強化します。

**カオスエンジニアリング**：
計画的に障害を起こし、システムの反応を観察します。

例：
- ランダムにサーバーを停止（Chaos Monkey）
- ネットワーク遅延を注入
- データベース接続を切断

これにより、実際の障害時の挙動を事前に把握し、対策を講じることができます。

### 早期発見システム

がん検診のように、問題の兆候を早期に発見します。

**異常検知AI**：
機械学習を使用して、通常とは異なるパターンを検出します。

- 通常の範囲を学習
- 異常なパターンをアラート
- 誤検知を減らすための継続的な調整

---

## 第6章：救急体制 ― インシデント対応組織

### オンコール体制

病院の当直医のように、24時間体制で対応します。

**体制構築**：
- プライマリ・セカンダリの2名体制
- ローテーション（週単位）
- エスカレーションパス明確化

### 緊急対応マニュアル

救急処置マニュアルのように、誰でも初期対応ができる手順書を準備します。

**ランブックの例**：
```
症状: API 500エラー多発

1. 状況確認
   - ダッシュボードで影響範囲確認
   - 最新デプロイの確認

2. 初期対応
   - ロードバランサーから問題サーバー除外
   - キャッシュTTL延長

3. 調査
   - エラーログ確認
   - APMで詳細分析

4. エスカレーション判断
   - 15分で解決しない → セカンダリを呼ぶ
   - 30分で解決しない → 責任者を呼ぶ
```

---

## 治療完了：健康なシステムへ

深夜の緊急コールから始まった戦いは、朝日とともに終わりを告げます。患者（システム）は回復し、チームは貴重な経験を得ました。

トラブルシューティングは、単なる問題解決ではありません。それは：
1. **迅速な診断**による影響最小化
2. **適切な治療**による確実な回復
3. **詳細な記録**による知識の蓄積
4. **予防医学**による再発防止
5. **チーム医療**による組織強化

次章では、これらの経験を活かしたベストプラクティスを総括します。

---

## 演習問題：救急診療シミュレーション

1. **トリアージ演習**：以下の症状を重症度順に並べ、それぞれの初期対応を決めてください：
   - データベース接続エラー（一部機能）
   - 決済システム完全停止
   - 検索機能の速度低下
   - ログインできないユーザーが1名

2. **診断演習**：「朝9時になると必ずシステムが遅くなる」という症状から、考えられる原因を5つ挙げ、それぞれの検査方法を提案してください。

3. **予防計画**：あなたのシステムの「健康診断」計画を作成してください。日次、週次、月次で何をチェックすべきか具体的に記述してください。

---

**💡 実装の詳細は付録をご覧ください**
- [付録34-A: トラブルシューティングツール集](../appendices/chapter34-implementation.md)
- [付録34-B: インシデント対応テンプレート](../appendices/chapter34-implementation.md#templates)
- [付録34-C: 異常検知システムの構築](../appendices/chapter34-implementation.md#anomaly)