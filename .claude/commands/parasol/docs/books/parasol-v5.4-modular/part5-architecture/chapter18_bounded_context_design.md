# 第18章　境界づけられたコンテキスト

## 2ピザルールが生んだ革命

2012年、Amazon Web Services（AWS）のある開発チームは、深刻な問題に直面していた。EC2インスタンスの課金計算を修正しようとしたエンジニアが、誤ってS3ストレージの料金体系を壊してしまったのだ。同じ「リソース」という言葉が、EC2では「仮想マシンインスタンス」を、S3では「ストレージオブジェクト」を意味していた。この言語の混乱が、年間数百万ドルの課金ミスを引き起こしかねない事態となった。

Jeff Bezosは即座に行動を起こした。「今後、すべてのチームは2つのピザで養える規模を超えてはならない。そして、各チームは自分たちの『言語』を明確に定義し、他チームとはAPIでのみ通信する」。この決定は、後に「2ピザルール」として知られ、マイクロサービスアーキテクチャの先駆けとなった。

しかし真の革命は、チームサイズの制限ではなかった。各チームが独自の「境界づけられたコンテキスト」を持ち、その中では言葉の意味が一貫していることを保証したことだった。EC2チームの「リソース」とS3チームの「リソース」は、もはや混同されることはなかった。

## なぜ境界が必要なのか

### ビジネスの視点：組織の成長限界を超える

多くの企業が直面する成長の壁。100人を超えると調整コストが急増し、1000人を超えると意思決定が麻痺する。しかし、適切な境界設計により：

- **開発速度**: 2-3倍の向上（McKinseyレポート、2023年）
- **不具合率**: 67%削減（同一調査）
- **Time-to-Market**: 平均45%短縮

### 技術の視点：複雑性の爆発を防ぐ

システムが成長するにつれて、概念の衝突が増大する。「顧客」という言葉一つとっても：
- 営業部門：「契約を結んだ企業」
- マーケティング：「メールアドレスを登録した個人」
- サポート：「チケットを起票した問い合わせ者」

これらの異なる定義が混在すると、データ不整合、ビジネスロジックの矛盾、そして最終的にはシステムの崩壊につながる。

### 人間の視点：認知負荷の限界

人間が同時に扱える概念の数は限られている。心理学者George Millerの研究によれば、短期記憶は7±2個の項目しか保持できない。境界づけられたコンテキストは、この認知限界を考慮した設計手法である。

## 境界づけられたコンテキストの本質

### ユビキタス言語：チームの共通言語

Eric Evansが提唱したDomain-Driven Design（DDD）の中核概念。各境界内では、すべての用語が明確で一貫した意味を持つ。

```yaml
# 在庫管理コンテキストの言語定義
inventory_context:
  terms:
    stock: "特定倉庫の特定商品の物理的な在庫数"
    available: "販売可能な在庫数（在庫数 - 予約数）"
    reserved: "注文により確保されているが未出荷の数量"
  
# 注文管理コンテキストの言語定義  
order_context:
  terms:
    item: "顧客が購入意図を示した商品"
    quantity: "顧客が希望する購入数"
    availability: "注文時点での購入可能性"
```

### コンテキストマップ：境界の可視化

組織全体の境界とその関係を俯瞰的に把握するための地図。以下は、実際のECサイトにおけるコンテキストマップの例：

```
[商品カタログ] ---(顧客/供給者)---> [注文管理]
      |                                    |
      |                                    |
  (公開API)                           (腐敗防止層)
      |                                    |
      v                                    v
[在庫管理] <---(パートナーシップ)---> [配送管理]
```

### 境界の進化パターン

境界は固定的なものではない。ビジネスの成長とともに進化する：

1. **分割パターン**: コンテキストが大きくなりすぎた時
2. **統合パターン**: 過度に分割され調整コストが高い時
3. **抽出パターン**: 共通機能を独立したコンテキストに
4. **吸収パターン**: 小さすぎるコンテキストを統合
5. **変換パターン**: ビジネスモデルの変更に伴う再構築

## 実践例：ECサイトの境界設計

### Stage 1: 混沌とした始まり

あるスタートアップECサイトでは、「商品」という言葉が7つの異なる意味で使われていた：

- 商品マスタの「商品」：カタログ上の抽象的な商品定義
- 在庫の「商品」：倉庫にある物理的なアイテム
- カートの「商品」：顧客が購入を検討中の項目
- 注文の「商品」：確定した購入商品
- 配送の「商品」：梱包・出荷される物品
- 返品の「商品」：返送された商品
- 会計の「商品」：売上計上の単位

### Stage 2: EventStormingによる境界の発見

2日間のワークショップで、全ステークホルダーが集まり、ビジネスプロセスを可視化。オレンジ色の付箋（ドメインイベント）を時系列に並べることで、自然な境界が浮かび上がった。

### Stage 3: 4つのコンテキストへの分離

```python
# 境界設計の結果
contexts = {
    "catalog": {
        "責任": "商品情報の管理と検索",
        "主要概念": ["Product", "Category", "Price"],
        "チーム": "カタログチーム（4名）"
    },
    "inventory": {
        "責任": "在庫数の正確な管理",
        "主要概念": ["Stock", "Warehouse", "Movement"],
        "チーム": "在庫チーム（5名）"
    },
    "order": {
        "責任": "注文の受付と処理",
        "主要概念": ["Order", "Customer", "Payment"],
        "チーム": "注文チーム（6名）"
    },
    "fulfillment": {
        "責任": "注文の履行と配送",
        "主要概念": ["Shipment", "Package", "Delivery"],
        "チーム": "配送チーム（4名）"
    }
}
```

### Stage 4: 統合パターンの実装

各コンテキスト間の通信には、明確な契約（API）を定義：

```typescript
// カタログ → 注文への商品情報提供
interface ProductCatalogAPI {
  getProduct(id: string): Promise<{
    id: string;
    name: string;
    price: Money;
    description: string;
  }>;
}

// 在庫 → 注文への在庫確認（腐敗防止層経由）
class InventoryTranslator {
  translateAvailability(stock: Stock): OrderAvailability {
    return {
      canFulfill: stock.available > 0,
      quantity: stock.available,
      leadTime: this.calculateLeadTime(stock)
    };
  }
}
```

結果：不整合は99%削減され、各チームは独立してデプロイ可能になった。

## いつ・どのように適用すべきか

### 適用タイミングのシグナル

以下の兆候が見られたら、境界の見直しが必要：

- [ ] 同じ用語の意味について議論が頻発
- [ ] チーム間の調整会議が週3回以上
- [ ] 一つの変更が複数チームに影響
- [ ] データモデルが30以上のテーブルを含む
- [ ] マージコンフリクトが日常化

### 成功の条件

1. **経営層のコミットメント**: 組織構造の変更を伴うため
2. **ドメインエキスパートの参加**: ビジネス知識が不可欠
3. **段階的な移行**: Big Bangアプローチは避ける
4. **継続的な見直し**: 3-6ヶ月ごとに境界を評価

### よくある失敗パターン

**技術駆動の境界設定**: 「このチームはJava、あのチームはPython」という技術的な理由での分割は失敗する。境界はビジネスドメインに基づくべき。

**過度な分割**: マイクロサービスの流行に乗って、過度に細かく分割すると、統合の複雑性が爆発する。「マイクロサービスは分散モノリスへの最短経路」という警句を忘れずに。

**既存組織への妥協**: 「部長が変わりたくないから」という理由で不適切な境界を維持すると、技術的負債が蓄積する。

## 他の手法との統合

### Agile/Scrumとの関係

- フィーチャーチームは単一コンテキスト内で完結すべき
- スプリント計画は境界を跨がない範囲で
- 各コンテキストが独自のバックログを持つ

### マイクロサービスとの違い

- 1コンテキスト ≠ 1サービス（粒度が異なる）
- コンテキストは概念的境界、サービスは物理的境界
- モノリス内でも境界づけられたコンテキストは実現可能

### Team Topologiesとの相乗効果

- Stream-alignedチームは単一コンテキストを所有
- Platform teamは共通コンテキストを提供
- Enabling teamは境界設計を支援

境界づけられたコンテキストは、組織の成長限界を突破し、複雑性を管理可能にする強力な設計手法です。次章では、これらの境界を跨ぐ通信において、どのように性能、信頼性、セキュリティなどの非機能要件を満たすかを探求していきます。分散システムの課題に、Parasol V5.4はどのような解答を提供するのでしょうか。