# Chapter 21 設計書: 集約設計

## 基本情報
- **パート**: Part 5 - Solution Space (Software Design)
- **位置**: 第21章 / 全38章
- **想定執筆時間**: 4時間
- **現在の状態**: 未着手
- **コード比率**: 現在0% → 目標30%

## 章の位置づけ

### 前章からの継続
- **Chapter 20**: ドメインモデリング
- **引き継ぐ概念**: ユビキタス言語、ドメインモデル、エンティティと値オブジェクト
- **前提となる理解**: ドメインの概念をコードで表現する基本、Venetian Principle（ビジネス言語の重要性）

### 本章の役割
- **主要学習目標**: 複雑なドメインモデルを一貫性のある単位（集約）に組織化する方法を理解する
- **解決する問題**: モデル間の複雑な関連、トランザクション境界の曖昧さ、不整合の発生
- **導入する概念**: 集約、集約ルート、トランザクション境界、結果整合性

### 次章への準備
- **Chapter 22**: CQRSとイベントソーシング
- **橋渡しする要素**: 集約を通じたコマンド処理、集約境界を越えたイベント連携
- **準備する概念**: 書き込みモデルとしての集約、イベント発行の起点

## 読者層別価値提供

### エグゼクティブ向け価値
- **ビジネスケース**: 一貫性のあるビジネストランザクションの実現、データ整合性リスクの軽減
- **ROI/リスク情報**: 不整合によるビジネス損失の防止、システム複雑性の管理コスト削減
- **意思決定ポイント**: どのレベルの一貫性が必要か、即時一貫性vs結果整合性のトレードオフ
- **読了時間**: 5分

### アーキテクト向け価値
- **設計原則**: 集約設計の4つの基本ルール、境界の決定方法
- **パターンと選択**: 大きな集約vs小さな集約、参照方法（ID参照vs直接参照）
- **トレードオフ分析**: パフォーマンスvs一貫性、開発容易性vs運用複雑性
- **読了時間**: 40分

### 開発者向け価値
- **実装ガイド**: 集約ルートの実装パターン、不変条件の実装方法
- **ツールと手法**: ORMでの集約マッピング、テスト戦略
- **コード例の場所**: 付録21.1（完全な集約実装例）
- **読了時間**: 20分

## 詳細構成

### Section 1: フック (500-800語)
**ストーリー候補**: 銀行の送金システムにおける二重引き落とし事故
**選定理由**: トランザクション境界の重要性を実感できる身近な例
**導入する緊張感**: 「なぜ21世紀になっても、こんな初歩的なミスが起きるのか？」

### Section 2: 問題の本質 (300-500語)
**抽象化する課題**: 複数のエンティティ間で守るべき不変条件
**3層の関心事**:
- ビジネス課題: ビジネスルールの一貫性保証、複雑な業務制約の実現
- アーキテクチャ課題: トランザクション境界の設計、スケーラビリティとの両立
- 実装課題: 並行処理での競合状態、ORマッピングの複雑性

### Section 3: 核心概念 (800-1200語)
**中心となる理論/フレームワーク**: DDDにおける集約パターン
**導入順序**:
1. 集約とは何か - 一貫性境界としての定義
2. 集約ルートの役割 - ゲートキーパーとしての責務
3. 集約設計の基本ルール - サイズ、参照、トランザクション
4. 結果整合性の考え方 - 境界を越えた協調

**ビジュアル表現**: 
- 図21-1: 注文集約の境界（Order, OrderLine, Productの関係）
- 図21-2: ID参照による集約間の疎結合

### Section 4: 実世界例 (600-1000語)
**選定した例**: ECサイトの在庫管理システム
**段階的展開**:
1. 初期状態: すべてが密結合な巨大モデル
2. 課題認識: 在庫更新時のデッドロック頻発
3. 解決適用: 商品集約と在庫集約の分離、イベントでの連携
4. 結果評価: スループット向上、保守性の改善

**コードブロック計画**:
- Block 1 (8行): 集約ルートの基本インターフェース
- Block 2 (12行): 不変条件を守るビジネスロジック例
- Block 3 (10行): 集約間のID参照パターン

### Section 5: 実践ガイダンス (400-600語)
**適用タイミング**: 複数エンティティ間に不変条件がある、トランザクション競合が発生
**成功条件**: 明確な境界定義、適切なサイズ、ビジネス言語との一致
**よくある失敗**: 巨大集約による性能問題、細かすぎる集約による一貫性喪失
**チェックリスト**: 
- [ ] 各集約は単一のトランザクションで更新可能か
- [ ] 集約境界はビジネス的に意味があるか
- [ ] ID参照で集約間を疎結合にしているか

### Section 6: 技術統合 (300-500語)
**既存手法との関係**:
- Microservices: サービス境界と集約境界の整合性
- Event Sourcing: 集約を起点としたイベント生成
- CQRS: 書き込みモデルとしての集約設計

**次章への流れ**: 集約がコマンドを処理し、イベントを生成する仕組みへ

## 付録配置計画

### Appendix 21.1: 完全実装例
- 移動対象: 注文集約の完全な実装（100行程度）
- 想定行数: 150行（テストコード含む）
- 参照方法: 「完全な実装例は付録21.1参照」

### Appendix 21.2: 集約設計パターンカタログ
- 移動対象: 各種ドメインでの集約パターン集
- フォーマット: パターン名、コンテキスト、実装例
- 使用説明: ドメイン別の参考実装

### Appendix 21.3: 集約とDBマッピング
- 対象ツール: JPA/Hibernate、Entity Framework等
- セットアップ手順: ORMでの集約マッピング設定
- トラブルシュート: Lazy Loading、N+1問題の回避

## 品質チェックリスト

### 執筆前確認
- [x] 前章の内容を正確に引き継いでいるか
- [x] 3読者層の価値が明確か
- [x] ストーリーは魅力的か
- [x] コード配分計画は30%以下か

### 執筆後確認
- [ ] 70:30比率達成
- [ ] 6セクション構成準拠
- [ ] 用語統一（スタイルガイド準拠）
- [ ] 前後章との整合性
- [ ] 図表の効果的使用

## リスクと対策

| リスク項目 | 影響度 | 対策 |
|-----------|--------|------|
| 技術的詳細への偏重 | 高 | ビジネス価値を常に強調 |
| 抽象的すぎる説明 | 中 | 具体的な銀行・EC例を使用 |
| ORMの詳細に深入り | 中 | 実装詳細は付録に分離 |

## メモ・特記事項

- Chapter 20で導入したVenetian Principleを継承し、「集約もビジネス言語で語られるべき」という観点を維持
- Chapter 22のCQRSにつながるよう、「書き込みモデルとしての集約」という視点を後半で導入
- 金融（銀行送金）、EC（在庫管理）、物流（配送管理）など、複数ドメインの例を含める
- Eric Evansの原典を参照しつつ、実践的な解釈を提供

---

設計者: parasol-book-architect
設計日: 2025-12-28
最終更新: 2025-12-28