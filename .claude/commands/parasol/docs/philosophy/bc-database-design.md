# BC単位のデータベース設計：ドメイン言語からの導出

**バージョン**: 1.0
**最終更新**: 2025-01-08
**位置づけ**: V5設計思想の核心（時間軸分割の帰結）

---

## 核心的主張

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  ソフトウェア設計の新しい常識：                                             │
│                                                                              │
│  「すべてのデータを一つのデータベースにリレーションで設計する」のではなく、 │
│  「BCの範囲で決めたドメイン言語からDB設計を導出する」                       │
│                                                                              │
│  Stage → CL2（Subdomain）→ CL3（BC）→ Service → Database                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## SubdomainとBCのCLレベル対応

### DDDの概念整理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  問題空間 vs 解決空間                                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  【問題空間】                    【解決空間】                               │
│                                                                              │
│      Domain                         System                                  │
│         │                              │                                    │
│         ▼                              ▼                                    │
│   ┌───────────┐                 ┌───────────┐                              │
│   │ Subdomain │  ─────────────▶ │    BC     │                              │
│   │（問題領域）│    対応関係     │（実装境界）│                              │
│   └───────────┘                 └───────────┘                              │
│                                                                              │
│   Subdomain ≠ BC（概念的には別物）                                         │
│   Subdomain ≒ BC（実務的には1:1対応が多い）                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### V5でのCLレベル対応

| 概念 | V5でのCLレベル | 説明 |
|------|---------------|------|
| **Subdomain** | **CL2** | 問題空間：「何の能力が必要か」 |
| **BC** | **CL3** | 解決空間：「どう実装するか」 |

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  V5のCL階層とDDD概念の対応                                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│      VS Stage                                                               │
│         │                                                                   │
│         ▼                                                                   │
│      ┌─────────┐                                                           │
│      │  CL1    │  Activity Area（活動領域）                                │
│      │         │  → 傾向的分類                                             │
│      └────┬────┘                                                           │
│           │                                                                 │
│           ▼                                                                 │
│      ┌─────────┐                                                           │
│      │  CL2    │  Capability（ケイパビリティ）                             │
│      │         │  → TVDC正式分類                                           │
│      │         │  → ★ Subdomain（問題領域）に対応                         │
│      └────┬────┘                                                           │
│           │                                                                 │
│           ▼                                                                 │
│      ┌─────────┐                                                           │
│      │  CL3    │  Business Operation（業務オペレーション）                 │
│      │         │  → BC実装単位                                             │
│      │         │  → ★ Bounded Context（実装境界）に対応                   │
│      └─────────┘                                                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### SubdomainとBCの関係パターン

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  CL2（Subdomain）と CL3（BC）の関係                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  【パターン1：1対N（複雑な場合）】                                          │
│                                                                              │
│      CL2: 決済ケイパビリティ ← Subdomain（問題領域）                       │
│              │                                                              │
│              ├── CL3: カード決済オペレーション ← BC（実装境界）            │
│              ├── CL3: 振込決済オペレーション   ← BC                        │
│              └── CL3: ポイント決済オペレーション ← BC                      │
│                                                                              │
│      → 1つのSubdomain（CL2）に複数のBC（CL3）                              │
│      → 各BCが独自のDBを持つ                                                │
│                                                                              │
│  【パターン2：1対1（シンプルな場合）】                                      │
│                                                                              │
│      CL2: 注文確定ケイパビリティ ← Subdomain                               │
│              │                                                              │
│              └── CL3: 注文確定オペレーション ← BC                          │
│                                                                              │
│      → Subdomain = BC（1:1対応）                                           │
│      → 1つのDBで完結                                                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 実務的な指針

| パターン | 条件 | DB構成 |
|---------|------|--------|
| **CL2 : CL3 = 1 : 1** | シンプルなドメイン | Subdomain単位で1DB |
| **CL2 : CL3 = 1 : N** | 複雑なドメイン | BC（CL3）単位で複数DB |

---

## 従来のデータベース設計

### 統合データベースアプローチ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  従来の設計思想                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│      ┌─────────────────────────────────────────────────────────────────┐   │
│      │                    Single Database                              │   │
│      │                                                                  │   │
│      │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐   │   │
│      │  │顧客TBL │──│注文TBL │──│商品TBL │──│在庫TBL │──│配送TBL │   │   │
│      │  └────────┘  └────────┘  └────────┘  └────────┘  └────────┘   │   │
│      │       │           │           │           │           │        │   │
│      │       └───────────┴───────────┴───────────┴───────────┘        │   │
│      │                                                                  │   │
│      │                    全テーブルがリレーション                      │   │
│      │                    どこからでもJOIN可能                          │   │
│      └─────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│      設計プロセス：                                                         │
│      要件 → ER図設計 → 正規化 → テーブル定義 → 実装                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 従来アプローチの問題

| 問題 | 説明 |
|------|------|
| **密結合** | 全テーブルがリレーションで結合、変更が全体に波及 |
| **スキーマ変更困難** | 1テーブルの変更が多数のアプリに影響 |
| **スケーリング困難** | データベース全体をスケールする必要 |
| **チーム依存** | 1つのDBに複数チームが依存、調整コスト大 |
| **技術固定** | 全システムが同一DBMSに縛られる |

---

## V5のデータベース設計

### BC単位のデータベースアプローチ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  V5の設計思想                                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│      時間 ──────────────────────────────────────────────────▶              │
│                                                                              │
│      ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐          │
│      │  検討BC   │  │  購買BC   │  │  出荷BC   │  │  受取BC   │          │
│      │           │  │           │  │           │  │           │          │
│      │ ┌───────┐ │  │ ┌───────┐ │  │ ┌───────┐ │  │ ┌───────┐ │          │
│      │ │Service│ │  │ │Service│ │  │ │Service│ │  │ │Service│ │          │
│      │ └───┬───┘ │  │ └───┬───┘ │  │ └───┬───┘ │  │ └───┬───┘ │          │
│      │     │     │  │     │     │  │     │     │  │     │     │          │
│      │ ┌───┴───┐ │  │ ┌───┴───┐ │  │ ┌───┴───┐ │  │ ┌───┴───┐ │          │
│      │ │  DB   │ │  │ │  DB   │ │  │ │  DB   │ │  │ │  DB   │ │          │
│      │ └───────┘ │  │ └───────┘ │  │ └───────┘ │  │ └───────┘ │          │
│      └───────────┘  └───────────┘  └───────────┘  └───────────┘          │
│                                                                              │
│      → 各BCが独自のデータベースを持つ                                      │
│      → BC間は直接JOINしない                                                │
│      → 各BCが独自のドメイン言語でスキーマを定義                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## ドメイン言語からDB設計への導出

### V5の設計トレーサビリティ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  V5の完全なトレーサビリティ                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│      Value Stream（価値の流れ）                                             │
│           │                                                                 │
│           │ Phase 2で定義                                                   │
│           ▼                                                                 │
│      ┌─────────┐                                                           │
│      │ Stage   │ ← 時間軸での分割点                                       │
│      └────┬────┘                                                           │
│           │                                                                 │
│           │ Phase 3で分解                                                   │
│           ▼                                                                 │
│      ┌─────────┐                                                           │
│      │   BC    │ ← Bounded Context                                        │
│      └────┬────┘                                                           │
│           │                                                                 │
│           │ Phase 5で設計                                                   │
│           ▼                                                                 │
│      ┌──────────────────┐                                                  │
│      │ Parasol Domain   │ ← BCごとのユビキタス言語                        │
│      │ Language         │                                                  │
│      │                  │   ・エンティティ                                 │
│      │                  │   ・値オブジェクト                               │
│      │                  │   ・集約                                         │
│      │                  │   ・ドメインイベント                             │
│      └────┬─────────────┘                                                  │
│           │                                                                 │
│           │ ドメインモデルとして表現                                        │
│           ▼                                                                 │
│      ┌──────────────────┐                                                  │
│      │ Domain Model     │ ← コードで表現されたドメイン                    │
│      └────┬─────────────┘                                                  │
│           │                                                                 │
│           │ 永続化層として導出                                              │
│           ▼                                                                 │
│      ┌──────────────────┐                                                  │
│      │ DB Schema        │ ← ドメインモデルから導出されたスキーマ          │
│      └──────────────────┘                                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 従来 vs V5：設計プロセスの違い

| 観点 | 従来 | V5 |
|------|------|-----|
| **起点** | データ（ER図） | 価値（バリューストリーム） |
| **設計順序** | 要件→ER図→実装 | VS→BC→ドメインモデル→DB |
| **言語** | テーブル/カラム名 | BCごとのドメイン言語 |
| **正規化** | 全体最適で正規化 | BC内で最適化 |
| **関心事** | データの整合性 | ドメインの表現力 |

---

## Parasolドメイン言語とは

### BCごとのユビキタス言語

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  Parasolドメイン言語の例                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  【購買完了BC】のドメイン言語                                               │
│                                                                              │
│      エンティティ:                                                          │
│      ┌─────────────────────────────────────────────────────────────────┐   │
│      │  注文（Order）                                                   │   │
│      │    ・注文ID                                                      │   │
│      │    ・注文明細（OrderLine）のリスト                               │   │
│      │    ・配送先（ShippingAddress）                                   │   │
│      │    ・決済情報（Payment）                                         │   │
│      │    ・注文ステータス（OrderStatus）                               │   │
│      └─────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│      値オブジェクト:                                                        │
│      ┌─────────────────────────────────────────────────────────────────┐   │
│      │  配送先（ShippingAddress）                                       │   │
│      │    ・郵便番号、都道府県、市区町村、番地、建物名                  │   │
│      │                                                                  │   │
│      │  金額（Money）                                                   │   │
│      │    ・金額、通貨                                                  │   │
│      └─────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│      ドメインイベント:                                                      │
│      ┌─────────────────────────────────────────────────────────────────┐   │
│      │  注文確定（OrderPlaced）                                         │   │
│      │  決済完了（PaymentCompleted）                                    │   │
│      │  在庫引当完了（InventoryReserved）                               │   │
│      └─────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  → このドメイン言語がDB設計の基礎となる                                    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### ドメイン言語 → DBスキーマ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ドメインモデルからDB設計への導出                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  【ドメインモデル】                    【DBスキーマ】                       │
│                                                                              │
│  Order（集約ルート）          →       orders テーブル                      │
│    ├─ orderId                 →         order_id (PK)                      │
│    ├─ orderLines[]            →       order_lines テーブル（FK: order_id） │
│    ├─ shippingAddress         →         shipping_* カラム群（埋め込み）    │
│    ├─ payment                 →       payments テーブル or 埋め込み        │
│    └─ status                  →         status カラム                      │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  重要な原則                                                          │   │
│  │                                                                      │   │
│  │  ・集約ルート = テーブルの境界                                       │   │
│  │  ・値オブジェクト = 埋め込み or 別テーブル（BC内で判断）             │   │
│  │  ・ドメインイベント = イベントストアに保存                           │   │
│  │  ・他BCのエンティティ = IDのみ参照（JOINしない）                     │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## BC間のデータ連携

### 原則：直接JOINしない

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  BC間データ連携の原則                                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ❌ やってはいけないこと                                                    │
│                                                                              │
│      SELECT o.*, s.*, d.*                                                   │
│      FROM purchase_bc.orders o                                              │
│      JOIN shipping_bc.shipments s ON o.order_id = s.order_id  ← NG!        │
│      JOIN delivery_bc.deliveries d ON s.shipment_id = d.shipment_id        │
│                                                                              │
│      → BC境界を越えたJOINは密結合を生む                                    │
│      → スキーマ変更が他BCに影響                                            │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ✅ 推奨パターン                                                            │
│                                                                              │
│      1. イベント駆動                                                        │
│                                                                              │
│      ┌──────────┐   OrderPlaced   ┌──────────┐                            │
│      │ 購買BC   │ ───────────────▶ │ 出荷BC   │                            │
│      │   DB     │    イベント      │   DB     │                            │
│      └──────────┘                  └──────────┘                            │
│                                                                              │
│      2. API呼び出し（必要時のみ）                                          │
│                                                                              │
│      ┌──────────┐   GET /orders/123   ┌──────────┐                        │
│      │ 出荷BC   │ ◀─────────────────── │ 購買BC   │                        │
│      │          │      API             │   API    │                        │
│      └──────────┘                      └──────────┘                        │
│                                                                              │
│      3. データ複製（Read Model）                                           │
│                                                                              │
│      ┌──────────┐   イベント購読   ┌──────────────┐                       │
│      │ 購買BC   │ ────────────────▶ │ 出荷BC       │                       │
│      │   DB     │                   │ ・出荷DB     │                       │
│      └──────────┘                   │ ・注文参照用 │ ← 必要最小限のコピー  │
│                                      └──────────────┘                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### BC間参照のルール

| パターン | 使用場面 | 特徴 |
|---------|---------|------|
| **イベント駆動** | 非同期で十分な場合 | 最も疎結合、推奨 |
| **API呼び出し** | リアルタイム参照が必要な場合 | 同期的、依存関係発生 |
| **データ複製** | 頻繁な参照が必要な場合 | 結果整合性、読み取り高速 |

---

## 技術選択の自由

### BC単位でのDB選択

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  BC単位での技術選択                                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│      ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐          │
│      │  検討BC   │  │  購買BC   │  │  分析BC   │  │  検索BC   │          │
│      │           │  │           │  │           │  │           │          │
│      │ ┌───────┐ │  │ ┌───────┐ │  │ ┌───────┐ │  │ ┌───────┐ │          │
│      │ │ Redis │ │  │ │Postgres│ │  │ │BigQuery│ │  │ │Elastic│ │          │
│      │ │キャッシュ│ │  │ │ RDBMS │ │  │ │  DWH  │ │  │ │ 全文検索│ │          │
│      │ └───────┘ │  │ └───────┘ │  │ └───────┘ │  │ └───────┘ │          │
│      └───────────┘  └───────────┘  └───────────┘  └───────────┘          │
│                                                                              │
│      → 各BCの特性に最適なDBを選択可能                                      │
│      → 検討BC: 高速読み取り → Redis                                       │
│      → 購買BC: トランザクション → PostgreSQL                              │
│      → 分析BC: 大量データ分析 → BigQuery                                  │
│      → 検索BC: 全文検索 → Elasticsearch                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 従来との比較まとめ

| 観点 | 従来（統合DB） | V5（BC単位DB） |
|------|---------------|---------------|
| **データベース数** | 1つ | BCの数だけ |
| **スキーマ設計** | 全体最適 | BC内最適 |
| **言語** | 統一されたテーブル名 | BCごとのドメイン言語 |
| **変更影響** | 全体に波及 | BC内に局所化 |
| **スケーリング** | 全体をスケール | BC単位でスケール |
| **技術選択** | 統一DBMS | BC単位で選択可能 |
| **チーム編成** | DB共有で調整必要 | BC単位で自律 |
| **JOIN** | どこでも可能 | BC内のみ |

---

## 実践例：ECサイト

### 従来の設計

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  従来のECサイトDB設計                                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│      ┌─────────────────────────────────────────────────────────────────┐   │
│      │                    ec_database                                   │   │
│      │                                                                  │   │
│      │  customers ─┬─ orders ─┬─ order_items ─┬─ products              │   │
│      │             │          │               │                        │   │
│      │             │          └─ shipments ───┴─ inventory             │   │
│      │             │                │                                  │   │
│      │             └─ payments ─────┴─ deliveries                      │   │
│      │                                                                  │   │
│      │  → 15テーブル以上が相互参照                                      │   │
│      │  → どこからでもJOIN可能                                          │   │
│      │  → 1テーブル変更で多数のクエリに影響                             │   │
│      └─────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### V5の設計

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  V5のECサイトDB設計                                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│      ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│      │ 検討BC DB   │  │ 購買BC DB   │  │ 出荷BC DB   │  │ 受取BC DB   │  │
│      │             │  │             │  │             │  │             │  │
│      │ ・browsing  │  │ ・orders    │  │ ・shipments │  │ ・deliveries│  │
│      │   _history  │  │ ・order_    │  │ ・packing   │  │ ・receipts  │  │
│      │ ・favorites │  │   lines     │  │ ・tracking  │  │ ・reviews   │  │
│      │ ・cart_     │  │ ・payments  │  │             │  │             │  │
│      │   items     │  │             │  │             │  │             │  │
│      └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │
│                                                                              │
│      → 各BCが3-5テーブル程度                                               │
│      → BC内でのみJOIN                                                      │
│      → 変更がBC内に閉じる                                                  │
│      → チームが独立してスキーマ変更可能                                    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 結論

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  ソフトウェア設計の新しい常識                                               │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │  1. 時間軸でステージを分割（Value Stream → Stage）                  │   │
│  │  2. ステージごとにBCを定義（Stage = BC）                            │   │
│  │  3. BCごとにドメイン言語を定義（Parasol Domain Language）           │   │
│  │  4. ドメインモデルからDB設計を導出                                  │   │
│  │  5. BC単位でデータベースを分離（BC = Database）                     │   │
│  │  6. BC間はイベント/APIで連携（JOINしない）                          │   │
│  │                                                                      │   │
│  │  Stage = BC = Service = Database = 独自のドメイン言語               │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  これにより：                                                               │
│  ・変更がBC内に局所化される                                                 │
│  ・独立したデプロイ/スケーリングが可能                                      │
│  ・チームが自律的に開発できる                                               │
│  ・技術選択の自由度が高い                                                   │
│  ・ドメイン言語がビジネスとコードを繋ぐ                                     │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 関連ドキュメント

- [time-axis-decomposition.md](./time-axis-decomposition.md) - 時間軸でのケイパビリティ分割
- [cl-hierarchy.md](./cl-hierarchy.md) - CL階層の詳細定義
- [V5-BIZBOK-DESIGN-PHILOSOPHY-JA.md](../reference/V5-BIZBOK-DESIGN-PHILOSOPHY-JA.md) - BizBOKとの設計思想比較

---

**Parasol V5 - ドメイン言語駆動のマイクロサービス設計フレームワーク**
