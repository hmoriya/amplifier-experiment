name: Sync with Microsoft Amplifier

on:
  schedule:
    - cron: '0 0 * * 1'  # Every Monday at midnight UTC
  workflow_dispatch:      # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/microsoft/amplifier || true
          git fetch upstream main
      
      - name: Create sync branch
        run: |
          BRANCH_NAME="sync/amplifier-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
      
      - name: Sync documentation files
        run: |
          # Create directories if they don't exist
          mkdir -p upstream/docs
          
          # Clone Microsoft Amplifier to temp directory
          git clone --depth 1 https://github.com/microsoft/amplifier temp-amplifier
          
          # Copy documentation files
          if [ -d "temp-amplifier/docs" ]; then
            cp -r temp-amplifier/docs/* upstream/docs/ 2>/dev/null || true
          fi
          
          # Copy specific files
          [ -f "temp-amplifier/README.md" ] && cp temp-amplifier/README.md upstream/README-amplifier.md
          [ -f "temp-amplifier/ROADMAP.md" ] && cp temp-amplifier/ROADMAP.md upstream/ROADMAP.md
          [ -f "temp-amplifier/pyproject.toml" ] && cp temp-amplifier/pyproject.toml upstream/pyproject-amplifier.toml
          
          # Clean up
          rm -rf temp-amplifier
      
      - name: Check for changes
        id: check_changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git commit -m "sync: update from Microsoft Amplifier $(date +%Y-%m-%d)
          
          Automated sync of documentation and configuration files from upstream.
          
          Source: https://github.com/microsoft/amplifier"
      
      - name: Push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git push origin ${{ env.BRANCH_NAME }}
      
      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.BRANCH_NAME }}
          title: "Sync with Microsoft Amplifier"
          body: |
            ## Automated Sync from Microsoft Amplifier
            
            This PR contains the latest documentation and configuration updates from [Microsoft Amplifier](https://github.com/microsoft/amplifier).
            
            ### Files Updated
            - Documentation in `upstream/docs/`
            - Reference files (README, ROADMAP, pyproject.toml)
            
            ### Review Checklist
            - [ ] Review documentation changes
            - [ ] Check for any breaking changes
            - [ ] Ensure compatibility with our extensions
            
            ---
            *This is an automated PR created by the sync workflow.*
          labels: |
            documentation
            upstream-sync
            automated