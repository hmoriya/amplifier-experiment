# ADR-003: API Gatewayパターンの採用

## ステータス

**承認済み** (2025-11-27)

## コンテキスト

マイクロサービス化により、複数のサービスエンドポイントが存在する。クライアント（Web/Mobile/他システム）からのアクセスを一元管理する必要がある。

**課題:**
- クライアントが複数サービスのエンドポイントを個別に知る必要がある
- 認証・認可の処理が各サービスで重複
- レート制限、ロギング等の横断的関心事の管理
- サービスの内部構造がクライアントに露出

**要件:**
- 単一エントリーポイントの提供
- 認証・認可の一元化
- レート制限・スロットリング
- リクエストルーティング
- ロギング・監視
- API バージョニング対応

## 決定

**Kong Gateway（OSS版）をAPI Gatewayとして採用する。**

構成:
- Kong Gateway (OSS) をKubernetes上にデプロイ
- PostgreSQLをデータストアとして使用
- 主要プラグイン: JWT認証、Rate Limiting、Logging、Prometheus

## 結果

### 良い影響

1. **単一エントリーポイント**: クライアントは1つのエンドポイントのみ知ればよい。
2. **横断的関心事の集約**: 認証、レート制限、ロギングを一箇所で管理。
3. **サービス抽象化**: 内部サービス構造の変更がクライアントに影響しない。
4. **プラグインエコシステム**: 豊富なプラグインで機能拡張が容易。
5. **オープンソース**: ベンダーロックインを回避、コスト抑制。

### 悪い影響/トレードオフ

1. **単一障害点**: Gatewayがダウンすると全サービスにアクセス不可。
   - 対策: 高可用性構成（複数レプリカ + ロードバランサー）
2. **レイテンシ追加**: リクエストごとにGateway経由のホップが追加。
   - 影響: 数ms程度。R&D業務では許容範囲。
3. **運用負荷**: Gatewayの監視・設定管理が必要。

### リスク

1. **設定ミス**: 誤った設定によるセキュリティホール・障害。
   - 対策: 設定のコード化（Kong Declarative Config）、レビュープロセス
2. **パフォーマンスボトルネック**: 高負荷時のGatewayがボトルネック化。
   - 対策: 適切なサイジング、水平スケーリング

## 代替案

### 代替案1: AWS API Gateway

**評価:**
- メリット: フルマネージド、AWSサービスとの統合
- デメリット: ベンダーロックイン、カスタマイズ性の制限、コスト
- 判断: マルチクラウド戦略との整合性から見送り

### 代替案2: NGINX + Lua

**評価:**
- メリット: 高パフォーマンス、軽量
- デメリット: 認証・レート制限等の実装が必要、管理UI不足
- 判断: 機能面でKongより劣る（KongはNGINXベース）

### 代替案3: Envoy + カスタムフィルター

**評価:**
- メリット: 高パフォーマンス、サービスメッシュとの親和性
- デメリット: 設定が複雑、学習コスト高い
- 判断: サービスメッシュ導入時に再検討（ADR-007参照）

### 代替案4: Gateway なし（クライアント直接接続）

**評価:**
- メリット: シンプル、レイテンシなし
- デメリット: 横断的関心事の重複、サービス構造の露出
- 判断: マイクロサービス環境では管理が困難

## 関連

- ADR-001: マイクロサービスアーキテクチャの採用
- ADR-005: JWT認証の選択
- ADR-007: サービスメッシュの見送り
- integration-patterns.md

---

**作成者:** Claude (Parasol V4 Lite)
**作成日:** 2025-11-27
