# ADR-002: イベントバスとしてKafkaを選択

## ステータス

**承認済み** (2025-11-27)

## コンテキスト

マイクロサービス間の非同期通信基盤として、イベントバスを導入する必要がある。

**要件:**
- 高スループット: 研究データ、評価結果等の大量イベント処理
- 永続性: イベントの再処理・監査のための保存
- 順序保証: 同一エンティティのイベントは順序保証が必要
- スケーラビリティ: 負荷増加に対応可能
- 信頼性: データ損失なし

**候補技術:**
1. Apache Kafka
2. RabbitMQ
3. AWS SNS/SQS
4. Apache Pulsar

## 決定

**Apache Kafkaをイベントバスとして採用する。**

構成:
- 本番環境: 3ブローカークラスター
- レプリケーション: 3
- スキーマ管理: Confluent Schema Registry (Avro)
- イベント形式: CloudEvents 1.0

## 結果

### 良い影響

1. **高スループット**: 毎秒数十万メッセージの処理能力。R&Dデータ量に十分対応。
2. **永続性**: イベントをログとして永続保存。再処理・監査に対応。
3. **パーティションによる順序保証**: 同一キーのイベントは順序保証。
4. **スケーラビリティ**: パーティション追加で水平スケール可能。
5. **エコシステム**: Kafka Connect、ksqlDB等の豊富なツール群。
6. **実績**: 大規模システムでの実績が豊富。

### 悪い影響/トレードオフ

1. **運用複雑性**: ZooKeeper（またはKRaft）の管理が必要。
2. **学習コスト**: Kafkaの概念・運用知識が必要。
3. **リソース消費**: メモリ・ディスクの消費が大きい。
4. **遅延**: 即時性が必要な場合はRabbitMQより劣る（ただしmsレベル）。

### リスク

1. **運用スキル不足**: Kafka運用経験の不足。
   - 対策: マネージドサービス（Confluent Cloud / AWS MSK）の利用を検討
2. **パーティション設計ミス**: 不適切なパーティション設計によるホットスポット。
   - 対策: イベントタイプごとに適切なパーティションキー設計

## 代替案

### 代替案1: RabbitMQ

**評価:**
- メリット: 運用がシンプル、低遅延、柔軟なルーティング
- デメリット: イベント永続性が弱い、大量データ処理に不向き
- 判断: Point-to-Point通信には適するが、イベントソーシング的な用途には不向き

**補足:** RabbitMQは非同期ジョブ処理（評価依頼キュー等）に併用する。

### 代替案2: AWS SNS/SQS

**評価:**
- メリット: マネージドで運用負荷低、AWSとの親和性
- デメリット: ベンダーロックイン、順序保証の制限、コスト
- 判断: マルチクラウド戦略との整合性の観点から見送り

### 代替案3: Apache Pulsar

**評価:**
- メリット: Kafkaより新しく、機能豊富（階層化ストレージ等）
- デメリット: 採用実績がKafkaより少ない、エコシステムが小さい
- 判断: 将来的には検討価値あるが、現時点ではKafkaの実績を優先

## 関連

- ADR-001: マイクロサービスアーキテクチャの採用
- integration-patterns.md

---

**作成者:** Claude (Parasol V5)
**作成日:** 2025-11-27
