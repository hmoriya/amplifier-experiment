# ADR-003: API Gatewayパターンの採用

## ステータス
**承認済み** (2025-12-05)

## コンテキスト

マイクロサービスアーキテクチャ（ADR-001）の採用により、クライアント（Web、モバイル、外部パートナー）は複数のサービスと通信する必要がある。

課題:
1. **クライアント複雑性**: クライアントが多数のサービスエンドポイントを知る必要
2. **横断的関心事**: 認証、レート制限、ログ収集を各サービスで実装
3. **プロトコル変換**: 内部はgRPC、外部はREST
4. **バージョン管理**: APIバージョニングの一元管理
5. **セキュリティ**: 外部からの攻撃表面の最小化

## 決定

**API Gatewayパターンを採用する**

### 構成

```
┌─────────────────────────────────────────────────────────────┐
│                    クライアント層                            │
│  Web App    Mobile App    Partner API    Internal Tools     │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    API Gateway                               │
│  - 認証・認可                                                │
│  - レート制限                                                │
│  - リクエストルーティング                                     │
│  - プロトコル変換                                            │
│  - ログ・メトリクス収集                                       │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    マイクロサービス群                         │
│  R&D Platform | Brand Mgmt | Manufacturing | Marketing ...  │
└─────────────────────────────────────────────────────────────┘
```

### 技術選定

- **外部向け**: Kong Gateway（OSS）または AWS API Gateway
- **内部向け**: サービスメッシュ（Istio）を将来検討

### 機能

| 機能 | 実装 |
|------|------|
| 認証 | JWT検証、OAuth 2.0 |
| 認可 | RBAC、ポリシーベース |
| レート制限 | トークンバケット方式 |
| ルーティング | パスベース、ヘッダーベース |
| 変換 | REST ↔ gRPC |
| 監視 | OpenTelemetry連携 |

## 結果

### 良い影響

1. **クライアント簡素化**: 単一エンドポイントで全サービスアクセス
2. **横断的関心事の集約**: 認証、ログ等を一箇所で管理
3. **セキュリティ強化**: 攻撃表面の最小化、WAF統合
4. **API管理**: バージョニング、廃止管理の一元化
5. **柔軟なデプロイ**: バックエンドサービスの変更がクライアントに影響しない

### 悪い影響/トレードオフ

1. **単一障害点**: Gateway障害時に全サービス影響
   - 軽減策: 高可用性構成（複数ノード、マルチAZ）
2. **レイテンシ追加**: 1ホップ増加（〜5ms）
   - 軽減策: 内部通信はGateway経由しない選択肢
3. **運用負荷**: Gateway自体の運用・監視
   - 軽減策: マネージドサービス活用
4. **ボトルネックリスク**: 高負荷時にGatewayが律速
   - 軽減策: 適切なスケーリング、キャッシング

### リスク

1. **過度な責務集中**: Gatewayにロジックを詰め込みすぎる
   - 軽減策: ルーティングと横断的関心事のみ、ビジネスロジック禁止
2. **チーム間調整**: Gateway変更が複数チームに影響
   - 軽減策: GitOpsでの設定管理、レビュープロセス

## 代替案

### 代替案1: BFF（Backend for Frontend）のみ

クライアント種別ごとにBFFを配置。

**評価**:
- 利点: クライアント最適化、チーム独立性
- 欠点: 共通機能（認証等）の重複
- 決定: API Gatewayと組み合わせて使用（BFFはGateway配下）

### 代替案2: サービスメッシュのみ

Istio等で全通信を制御。

**評価**:
- 利点: 内部通信も統一的に制御
- 欠点: 外部向けAPI管理機能が弱い、複雑性
- 決定: 将来の内部通信制御として検討継続

### 代替案3: 各サービスで直接公開

Gatewayなしで各サービスを直接公開。

**評価**:
- 利点: シンプル、レイテンシ最小
- 欠点: 横断的関心事の重複、セキュリティリスク
- 却下理由: 運用・セキュリティ上の問題が大きい

## 関連

- ADR-001: マイクロサービスアーキテクチャの採用
- ADR-005: JWT認証方式の選択
- integration-patterns.md: REST API標準
