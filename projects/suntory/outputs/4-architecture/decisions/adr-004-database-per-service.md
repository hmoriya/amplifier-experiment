# ADR-004: Database per Serviceパターン

## ステータス
**承認済み** (2025-12-05)

## コンテキスト

マイクロサービスアーキテクチャ（ADR-001）において、データベースの所有権をどう設計するかが重要な決定事項である。

課題:
1. **データ独立性**: サービス間でスキーマ変更の影響を受けない
2. **スケーラビリティ**: サービスごとに異なるスケール要件
3. **技術選択**: サービスごとに最適なデータストアを選択
4. **デプロイ独立性**: DB変更を含めて独立デプロイ
5. **データ整合性**: サービス間のデータ整合性をどう担保するか

## 決定

**Database per Serviceパターンを採用する**

各サービスは専用のデータベースを持ち、他サービスのDBに直接アクセスしない。

### 実装方針

```
┌─────────────────────────────────────────────────────────────┐
│                    サービス別データストア                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  R&D Platform:                                              │
│    PostgreSQL (研究データ) + MongoDB (ドキュメント)         │
│    + Elasticsearch (検索)                                   │
│                                                             │
│  Manufacturing:                                             │
│    PostgreSQL (製造データ) + InfluxDB (センサーデータ)      │
│                                                             │
│  Customer Platform:                                         │
│    PostgreSQL (顧客マスタ) + Neo4j (関係グラフ)            │
│    + Elasticsearch (検索)                                   │
│                                                             │
│  Supply Chain:                                              │
│    PostgreSQL (調達・物流) + Redis (在庫キャッシュ)        │
│                                                             │
│  Finance:                                                   │
│    PostgreSQL (会計データ) ※強いトランザクション要件       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### データ共有方式

1. **API経由**: 同期的なデータ取得
2. **イベント経由**: 非同期的なデータ伝播
3. **共有読み取りビュー**: 必要に応じてBIツール用に集約

### 整合性モデル

- **サービス内**: 強い整合性（ACID）
- **サービス間**: 結果整合性（Eventual Consistency）

## 結果

### 良い影響

1. **独立性**: スキーマ変更が他サービスに影響しない
2. **技術最適化**: RDBからNoSQLまで最適な選択が可能
3. **スケーラビリティ**: サービスごとにDBスケール可能
4. **障害分離**: 1つのDB障害が全体に波及しない
5. **チーム自律性**: チームがDB設計・運用に責任を持つ

### 悪い影響/トレードオフ

1. **データ重複**: 同じデータが複数サービスに存在
   - 軽減策: イベント駆動での同期、Single Source of Truth明確化
2. **結合クエリ不可**: サービス横断のJOINができない
   - 軽減策: BIツール用の読み取りレプリカ、CQRS
3. **分散トランザクション**: 複数DBのACIDトランザクション不可
   - 軽減策: Sagaパターン、結果整合性の受け入れ
4. **運用コスト**: 複数DB運用のオーバーヘッド
   - 軽減策: マネージドサービス活用、Platform Teamサポート

### リスク

1. **データ不整合**: イベント処理失敗によるデータ乖離
   - 軽減策: リトライ、DLQ、整合性チェックバッチ
2. **クエリパフォーマンス**: 複数サービス呼び出しによる遅延
   - 軽減策: キャッシング、非同期プリフェッチ

## 代替案

### 代替案1: 共有データベース

全サービスが1つのDBを共有。

**評価**:
- 利点: JOIN可能、ACID保証、運用シンプル
- 欠点: 独立デプロイ困難、スキーマ変更リスク大
- 却下理由: マイクロサービスのメリットが失われる

### 代替案2: スキーマ per Service

1つのDB内でスキーマ（名前空間）を分離。

**評価**:
- 利点: 運用シンプル、リソース効率的
- 欠点: DBスケールが共通、技術選択の自由度低
- 決定: 小規模サービスの初期段階で検討可

### 代替案3: データメッシュ

ドメインチームがデータプロダクトとして提供。

**評価**:
- 利点: ドメイン責任明確、セルフサービス分析
- 欠点: 成熟度が必要、初期構築コスト
- 決定: 将来のデータプラットフォーム戦略として検討

## 関連

- ADR-001: マイクロサービスアーキテクチャの採用
- ADR-002: イベントバスとしてKafkaを選択
- integration-patterns.md: Sagaパターン、CQRS
