# ADR-006: 事業別サービスインスタンスの採用

## ステータス
**承認済み** (2025-12-05)

## コンテキスト

サントリーグループは5つの事業（飲料、スピリッツ、ビール、ワイン、健康食品）を持つ。Phase 3のドメイン分析において、マーケティングと製造管理は**B判定**（事業別管理）となった。

課題:
1. **事業特性の違い**: 各事業で顧客、チャネル、製造プロセスが根本的に異なる
2. **独立したビジネスリズム**: 繁忙期、新製品サイクルが事業ごとに異なる
3. **チーム構造**: 事業ごとに独立したマーケ・製造チームが存在
4. **スケール要件**: 事業ごとにトラフィックパターンが異なる
5. **コードベースの共通性**: 基本機能は共通だが、事業固有のカスタマイズが必要

## 決定

**マーケティングと製造管理は、共通コードベースから事業別インスタンスをデプロイする**

### 実装方針

```
┌─────────────────────────────────────────────────────────────┐
│                    事業別インスタンス構成                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  共通コードベース                                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  marketing-service/                                  │   │
│  │    ├── core/           # 共通ビジネスロジック        │   │
│  │    ├── adapters/       # 事業別アダプター            │   │
│  │    │   ├── beverage/                                 │   │
│  │    │   ├── spirits/                                  │   │
│  │    │   ├── beer/                                     │   │
│  │    │   ├── wine/                                     │   │
│  │    │   └── health/                                   │   │
│  │    └── config/         # 事業別設定                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  デプロイインスタンス                                        │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────┐│
│  │ MKT-Bev  │ │ MKT-Spi  │ │ MKT-Beer │ │ MKT-Wine │ │MKT-│││
│  │          │ │          │ │          │ │          │ │Hlth│││
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └────┘│
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### デプロイ戦略

| 項目 | 方針 |
|------|------|
| コードベース | 単一リポジトリ（モノレポ） |
| ビルド | 共通イメージ + 設定注入 |
| デプロイ | 事業別に独立デプロイ |
| データベース | 事業別に分離 |
| 設定 | 環境変数 + ConfigMap |

### 事業別カスタマイズ

```yaml
Marketing Service カスタマイズ例:

beverage:
  channels: [convenience, supermarket, vending]
  campaigns:
    types: [mass_media, digital, outdoor]
    approvalFlow: simplified

spirits:
  channels: [liquor_store, bar, limited_ec]
  campaigns:
    types: [premium, fan_marketing, event]
    approvalFlow: strict
    ageVerification: required

health:
  channels: [d2c, ec, drugstore]
  campaigns:
    types: [crm, ltv, subscription]
    approvalFlow: health_claims_review
```

## 結果

### 良い影響

1. **コード再利用**: 共通機能（CRUD、認証統合等）を共有
2. **独立デプロイ**: 事業ごとに異なるリリースサイクル
3. **独立スケール**: 繁忙期に応じた個別スケーリング
4. **障害分離**: 1事業の障害が他事業に影響しない
5. **チーム自律性**: 事業チームが自インスタンスに責任

### 悪い影響/トレードオフ

1. **運用オーバーヘッド**: 5インスタンス×2サービス=10デプロイユニット
   - 軽減策: 共通のCI/CDパイプライン、Platform Team支援
2. **コード重複リスク**: 事業固有コードの増殖
   - 軽減策: コアモジュールの厳格な管理、定期レビュー
3. **データ集約困難**: 全事業横断の分析が複雑化
   - 軽減策: 共通BI基盤、イベント集約層
4. **バージョン管理**: 各インスタンスのバージョン差異
   - 軽減策: 強制アップグレードポリシー、互換性テスト

### リスク

1. **フォークの発生**: 事業チームが独自ブランチを作成
   - 軽減策: 機能フラグ、プラグイン機構、ガバナンス
2. **統合の困難化**: 将来の事業統合時の技術負債
   - 軽減策: 共通APIコントラクト維持

## 代替案

### 代替案1: 完全な単一サービス

全事業を1つのサービスで処理。

**評価**:
- 利点: 運用シンプル、コード重複なし
- 欠点: 独立デプロイ不可、障害影響大
- 却下理由: 事業間の独立性要件を満たせない

### 代替案2: 完全に独立したサービス

事業ごとに別コードベース。

**評価**:
- 利点: 完全な独立性
- 欠点: コード重複大、共通機能の二重開発
- 却下理由: 開発効率が大幅に低下

### 代替案3: マルチテナント単一サービス

1サービスで事業をテナントとして処理。

**評価**:
- 利点: 運用シンプル、リソース効率的
- 欠点: 独立スケール困難、ノイジーネイバー問題
- 決定: 小規模事業では検討可

## 関連

- ADR-001: マイクロサービスアーキテクチャの採用
- ADR-004: Database per Serviceパターン
- service-boundaries.md: サービス境界定義
- Phase 3 CL1: B判定（事業別管理）ドメイン
