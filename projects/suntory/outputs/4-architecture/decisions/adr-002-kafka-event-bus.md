# ADR-002: イベントバスとしてKafkaを選択

## ステータス
**承認済み** (2025-12-05)

## コンテキスト

マイクロサービスアーキテクチャ（ADR-001）の採用に伴い、サービス間の非同期通信基盤が必要となった。

要件:
1. **高スループット**: 製造IoTデータ、顧客行動データの大量処理
2. **永続化**: イベントの再処理（リプレイ）が可能
3. **順序保証**: 同一エンティティのイベントは順序保証が必要
4. **スケーラビリティ**: 繁忙期のトラフィック増加に対応
5. **エコシステム**: Debezium（CDC）、Kafka Streams等との連携

## 決定

**Apache Kafkaをイベントバスとして採用する**

### 構成

```
プロダクション環境:
  ブローカー: 5ノード
  レプリケーション: 3
  パーティション: トピックごとに設計

主要トピック:
  - manufacturing.production.completed
  - customer.profile.updated
  - supply-chain.shipment.dispatched
  - sustainability.environmental-data.recorded
```

### 運用方針

- マネージドサービス（AWS MSK または Confluent Cloud）を使用
- CloudEvents形式でイベントを標準化
- Schema Registry（Avro）でスキーマ管理

## 結果

### 良い影響

1. **高スループット**: 数百万メッセージ/秒の処理能力
2. **イベントリプレイ**: 障害復旧、新規コンシューマーのキャッチアップ
3. **順序保証**: パーティション内での順序保証
4. **エコシステム**: CDC、ストリーム処理、コネクタが充実
5. **実績**: 大規模本番運用の実績が豊富

### 悪い影響/トレードオフ

1. **運用複雑性**: Zookeeper/KRaft、ブローカー管理
   - 軽減策: マネージドサービス使用
2. **学習コスト**: パーティショニング、コンシューマーグループの理解
   - 軽減策: トレーニング、ガイドライン整備
3. **レイテンシ**: リアルタイム（<10ms）には不向き
   - 軽減策: リアルタイム要件にはgRPC使用
4. **コスト**: 大規模クラスタの運用コスト
   - 軽減策: 適切なパーティション設計、圧縮

### リスク

1. **設計ミス**: パーティション設計の誤り
   - 軽減策: PoC実施、パーティション再配置手順整備
2. **スキーマ進化**: 互換性のないスキーマ変更
   - 軽減策: Schema Registry、互換性ルール強制

## 代替案

### 代替案1: RabbitMQ

伝統的なメッセージキュー。

**評価**:
- 利点: 柔軟なルーティング、AMQP標準
- 欠点: 大規模スループットに不向き、永続化が弱い
- 却下理由: IoTデータの大量処理に不向き

### 代替案2: AWS SNS/SQS

AWSマネージドPub/Sub。

**評価**:
- 利点: フルマネージド、AWS統合
- 欠点: イベントリプレイ不可、ベンダーロックイン
- 却下理由: マルチクラウド要件、リプレイ必須

### 代替案3: Apache Pulsar

次世代メッセージング。

**評価**:
- 利点: Kafka互換、多テナント、地理レプリケーション
- 欠点: エコシステムが未成熟、運用ノウハウ不足
- 却下理由: 成熟度とエコシステムでKafkaを選択

## 関連

- ADR-001: マイクロサービスアーキテクチャの採用
- integration-patterns.md: Event-Driven詳細
