# ADR-005: JWT認証方式の選択

## ステータス
**承認済み** (2025-12-05)

## コンテキスト

マイクロサービス環境（ADR-001）での認証・認可方式を決定する必要がある。

要件:
1. **ステートレス**: サービス間でセッション共有不要
2. **スケーラビリティ**: 認証サーバーがボトルネックにならない
3. **情報伝達**: ユーザー情報、権限をトークンに含める
4. **標準準拠**: OAuth 2.0 / OIDC互換
5. **パフォーマンス**: 各リクエストでの認証オーバーヘッド最小化

## 決定

**JWT（JSON Web Token）をアクセストークン形式として採用する**

### 実装方針

```
┌─────────────────────────────────────────────────────────────┐
│                    認証フロー                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. クライアント → IT Platform: ログイン要求                │
│  2. IT Platform → クライアント: JWT発行                     │
│  3. クライアント → API Gateway: JWT付きリクエスト           │
│  4. API Gateway: JWT検証（署名、有効期限）                  │
│  5. API Gateway → サービス: 検証済みリクエスト転送          │
│  6. サービス: JWT内のクレームで認可判定                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### JWT構造

```json
{
  "header": {
    "alg": "RS256",
    "typ": "JWT",
    "kid": "key-id-001"
  },
  "payload": {
    "iss": "https://auth.suntory.co.jp",
    "sub": "user-uuid",
    "aud": ["suntory-services"],
    "exp": 1735689600,
    "iat": 1735686000,
    "jti": "unique-token-id",
    "name": "山田太郎",
    "email": "yamada@suntory.co.jp",
    "roles": ["marketing-manager", "beverage-user"],
    "org": "ORG-BEV-001",
    "permissions": ["campaign:read", "campaign:write"]
  }
}
```

### トークン有効期限

| トークン種別 | 有効期限 | 用途 |
|--------------|----------|------|
| アクセストークン | 1時間 | API認証 |
| リフレッシュトークン | 7日 | アクセストークン再発行 |
| IDトークン | 1時間 | ユーザー情報取得 |

### 署名アルゴリズム

- **RS256**（RSA + SHA-256）を採用
- 公開鍵はJWKS（JSON Web Key Set）エンドポイントで公開
- 各サービスは公開鍵で検証（秘密鍵不要）

## 結果

### 良い影響

1. **ステートレス**: 各サービスで独立して検証可能
2. **スケーラビリティ**: 認証サーバーへの問い合わせ不要
3. **情報自己完結**: ユーザー情報、権限がトークンに含まれる
4. **標準準拠**: OAuth 2.0 / OIDC互換で外部連携容易
5. **パフォーマンス**: 署名検証のみで高速

### 悪い影響/トレードオフ

1. **トークン無効化困難**: 発行済みトークンの即時無効化が難しい
   - 軽減策: 短い有効期限、ブラックリスト（重要操作時のみ）
2. **トークンサイズ**: クレームが多いとサイズ増大
   - 軽減策: 必要最小限のクレーム、参照トークン検討
3. **鍵管理**: 秘密鍵の安全な管理が必要
   - 軽減策: HashiCorp Vault、定期ローテーション

### リスク

1. **トークン漏洩**: 盗まれたトークンの悪用
   - 軽減策: HTTPS必須、短い有効期限、IP制限
2. **鍵漏洩**: 秘密鍵が漏洩すると全トークン偽造可能
   - 軽減策: HSM使用、鍵ローテーション手順整備

## 代替案

### 代替案1: セッションベース認証

サーバーサイドセッション + セッションID。

**評価**:
- 利点: 即時無効化可能、トークンサイズ小
- 欠点: セッションストア共有必要、スケール困難
- 却下理由: マイクロサービス環境に不向き

### 代替案2: Opaque Token + Introspection

参照トークン + 認証サーバーへの問い合わせ。

**評価**:
- 利点: 即時無効化可能、トークンサイズ小
- 欠点: 認証サーバーがボトルネック、レイテンシ増
- 決定: 重要操作（資金移動等）では検討

### 代替案3: PASETO（Platform-Agnostic Security Tokens）

JWTの設計上の問題を解決した新規格。

**評価**:
- 利点: アルゴリズム固定で安全、シンプル
- 欠点: エコシステム未成熟、ライブラリ不足
- 却下理由: 現時点ではJWTの成熟度を優先

## 関連

- ADR-003: API Gatewayパターンの採用
- integration-patterns.md: 認証・認可詳細
