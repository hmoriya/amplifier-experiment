# Operation: op-001 水質検査実施 [AnalyzeWaterQuality]

## 概要

| 項目 | 値 |
|------|-----|
| ID | op-001 |
| 日本語名 | 水質検査実施 |
| 英語名 | AnalyzeWaterQuality |
| 定数名 | ANALYZE_WATER_QUALITY |
| 所属Capability | cap-001 水質分析 |
| ステータス | Draft |

## 説明

水サンプルを受け付け、定められた検査項目に従って品質検査を実施する。
検査結果を記録し、品質基準との照合を行い、合否判定を行う。

## 事前条件

- 検査対象の水サンプルが採取済みであること
- 水源が登録済みであること（op-003完了）
- 検査担当者が認証済みであること
- 適用する品質基準が設定済みであること

## 事後条件

- 検査結果が記録されていること
- 合否判定が確定していること
- 不合格の場合、アラートが発行されていること
- 検査履歴が更新されていること

## 入力

| パラメータ | 型 | 必須 | 説明 |
|------------|-----|------|------|
| sampleId | UUID | Yes | 水サンプルID |
| sourceId | UUID | Yes | 水源ID |
| productCategory | String | Yes | 製品カテゴリ（飲料/酒類/健康食品） |
| testItems | TestItem[] | Yes | 検査項目リスト |
| sampledAt | DateTime | Yes | サンプル採取日時 |
| sampledBy | UUID | Yes | 採取者ID |
| notes | String | No | 備考 |

## 出力

| フィールド | 型 | 説明 |
|------------|-----|------|
| testId | UUID | 検査ID |
| sampleId | UUID | 水サンプルID |
| results | TestResult[] | 検査結果リスト |
| conclusion | Enum | 判定（PASS/FAIL/RETEST） |
| testedAt | DateTime | 検査完了日時 |
| testedBy | UUID | 検査担当者ID |
| standardId | UUID | 適用した品質基準ID |

## ビジネスルール

1. **BR-001**: 検査項目は製品カテゴリごとに定義された必須項目をすべて含むこと
2. **BR-002**: サンプル採取から48時間以内に検査を開始すること
3. **BR-003**: 1つでも基準値外の項目があればFAIL判定
4. **BR-004**: 測定誤差範囲内の場合はRETEST判定
5. **BR-005**: 検査結果は改ざん不可（監査ログ記録）

## 例外・エラー

| エラーコード | 条件 | メッセージ |
|--------------|------|------------|
| E001 | 水源未登録 | 指定された水源が登録されていません |
| E002 | 基準未設定 | 製品カテゴリの品質基準が設定されていません |
| E003 | サンプル期限切れ | サンプル採取から48時間を超過しています |
| E004 | 必須項目不足 | 必須検査項目が不足しています |

## 関連UseCase

| ID | 名称 |
|----|------|
| uc-001 | 水質検査 [WaterQualityTest] |

## シーケンス

```
1. 水サンプル情報を受け付ける
2. 水源情報を取得・検証する
3. 適用する品質基準を特定する
4. 各検査項目の測定を実施する
5. 測定結果を記録する
6. 品質基準との照合を行う
7. 合否判定を確定する
8. 検査完了イベントを発行する
9. 不合格の場合、アラートを発行する
```

## ドメインイベント

| イベント | 発行条件 |
|----------|----------|
| WaterQualityTestCompleted | 検査完了時 |
| WaterQualityTestFailed | 不合格判定時 |

---

**作成日**: 2025-12-05
**更新日**: 2025-12-05
**作成者**: AI Assistant
