# Aggregates - BC-001 R&D 水科学

## 概要

本ドキュメントは、BC-001 R&D 水科学の集約を定義する。

---

## WaterSourceAggregate 水源集約

| 項目 | 値 |
|------|-----|
| 日本語名 | 水源集約 |
| ルートエンティティ | WaterSource |

### 説明

水源とその関連データ（検査履歴、涵養活動）をまとめた集約。
水源の登録、検査、涵養活動の一貫性を保証する。

### 含むエンティティ

| エンティティ | 関係 | 説明 |
|--------------|------|------|
| WaterSource | Root | 水源（ルート） |
| WaterQualityTest[] | 1:N | 水質検査履歴 |
| ConservationActivity[] | 1:N | 涵養活動履歴 |

### 含む値オブジェクト

| 値オブジェクト | 説明 |
|----------------|------|
| Location | 水源の位置情報 |
| MineralComposition | 水源の基本ミネラル組成 |
| WaterHardness | 水源の硬度 |

### 整合性境界

```
┌─────────────────────────────────────────────────────────┐
│  WaterSourceAggregate                                   │
│  ┌───────────────────────────────────────────────────┐ │
│  │  WaterSource (Root)                               │ │
│  │    ├── Location                                   │ │
│  │    ├── MineralComposition                         │ │
│  │    └── WaterHardness                              │ │
│  └───────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────┐ │
│  │  WaterQualityTest[]                               │ │
│  │    └── TestResult[]                               │ │
│  └───────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────┐ │
│  │  ConservationActivity[]                           │ │
│  └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 不変条件

1. 水源には少なくとも1件の合格済み水質検査が必要（初回検査）
2. 涵養活動の累計面積は常に正確に計算される
3. 水源の状態変更は検査結果に基づく

### 操作

| 操作 | 説明 |
|------|------|
| register() | 水源を登録する |
| addQualityTest() | 水質検査を追加する |
| recordConservation() | 涵養活動を記録する |
| updateStatus() | 水源の状態を更新する |
| calculateTotalConservationArea() | 累計涵養面積を計算する |

---

## QualityStandardAggregate 品質基準集約

| 項目 | 値 |
|------|-----|
| 日本語名 | 品質基準集約 |
| ルートエンティティ | QualityStandard |

### 説明

品質基準とそのバージョン履歴をまとめた集約。
基準の変更履歴と承認フローを管理する。

### 含むエンティティ

| エンティティ | 関係 | 説明 |
|--------------|------|------|
| QualityStandard | Root | 品質基準（ルート） |

### 含む値オブジェクト

| 値オブジェクト | 説明 |
|----------------|------|
| ParameterRange[] | 各パラメータの許容範囲 |
| DateRange | 有効期間 |

### 整合性境界

```
┌─────────────────────────────────────────────────────────┐
│  QualityStandardAggregate                               │
│  ┌───────────────────────────────────────────────────┐ │
│  │  QualityStandard (Root)                           │ │
│  │    ├── ParameterRange[]                           │ │
│  │    └── DateRange                                  │ │
│  └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 不変条件

1. 同一製品カテゴリで有効期間が重複する基準は存在しない
2. 承認済み基準のみ検査に適用可能
3. 基準の変更履歴は完全に保持される

### 操作

| 操作 | 説明 |
|------|------|
| create() | 新規基準を作成（DRAFT） |
| submit() | 承認申請する（PENDING） |
| approve() | 承認する（APPROVED→ACTIVE） |
| reject() | 却下する |
| expire() | 有効期限切れにする（EXPIRED） |

---

## PurificationProcessAggregate 浄水プロセス集約

| 項目 | 値 |
|------|-----|
| 日本語名 | 浄水プロセス集約 |
| ルートエンティティ | PurificationProcess |

### 説明

浄水プロセス設計とその技術移転をまとめた集約。
プロセスの設計、承認、移転の一貫性を保証する。

### 含むエンティティ

| エンティティ | 関係 | 説明 |
|--------------|------|------|
| PurificationProcess | Root | 浄水プロセス（ルート） |
| TechnologyTransfer[] | 1:N | 技術移転 |

### 含む値オブジェクト

| 値オブジェクト | 説明 |
|----------------|------|
| ProcessStep[] | 処理ステップ |
| TransferPhase[] | 移転フェーズ（各移転ごと） |

### 整合性境界

```
┌─────────────────────────────────────────────────────────┐
│  PurificationProcessAggregate                           │
│  ┌───────────────────────────────────────────────────┐ │
│  │  PurificationProcess (Root)                       │ │
│  │    └── ProcessStep[]                              │ │
│  └───────────────────────────────────────────────────┘ │
│  ┌───────────────────────────────────────────────────┐ │
│  │  TechnologyTransfer[]                             │ │
│  │    └── TransferPhase[]                            │ │
│  └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 不変条件

1. 承認済みプロセスのみ技術移転可能
2. 同一工場への同一プロセスの重複移転は不可
3. 移転フェーズは順次完了が必要

### 操作

| 操作 | 説明 |
|------|------|
| design() | プロセスを設計する |
| simulate() | シミュレーションを実行する |
| submit() | レビュー申請する |
| approve() | 承認する |
| startTransfer() | 技術移転を開始する |
| completeTransferPhase() | 移転フェーズを完了する |

---

**作成日**: 2025-12-05
**更新日**: 2025-12-05
