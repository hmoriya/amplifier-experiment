# Aggregates - BC-003 CRM-CDP 顧客データプラットフォーム

## 概要

本ドキュメントは、BC-003 CRM-CDPの集約を定義する。

---

## CustomerProfileAggregate 顧客プロファイル集約

| 項目 | 値 |
|------|-----|
| 日本語名 | 顧客プロファイル集約 |
| ルートエンティティ | CustomerProfile |

### 説明

顧客の統合プロファイルとそのID連携情報をまとめた集約。

### 含むエンティティ

| エンティティ | 関係 | 説明 |
|--------------|------|------|
| CustomerProfile | Root | 顧客プロファイル（ルート） |

### 含む値オブジェクト

| 値オブジェクト | 説明 |
|----------------|------|
| IdentityGraph | ID連携グラフ |
| Demographics | 人口統計属性 |
| ContactInfo | 連絡先情報 |
| Consent[] | 同意情報 |
| CustomerScore[] | 顧客スコア |

### 整合性境界

```
┌─────────────────────────────────────────────────────────┐
│  CustomerProfileAggregate                               │
│  ┌───────────────────────────────────────────────────┐ │
│  │  CustomerProfile (Root)                           │ │
│  │    ├── IdentityGraph                              │ │
│  │    │     └── Identifier[]                         │ │
│  │    ├── Demographics                               │ │
│  │    ├── ContactInfo                                │ │
│  │    ├── Consent[]                                  │ │
│  │    └── CustomerScore[]                            │ │
│  └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 不変条件

1. 統合顧客IDは一度作成したら変更不可
2. 同意情報は常に最新状態を保持
3. ID統合時は既存プロファイルとマージ

### 操作

| 操作 | 説明 |
|------|------|
| createProfile() | 新規プロファイル作成 |
| mergeIdentity() | ID統合・名寄せ |
| updateAttribute() | 属性更新 |
| updateConsent() | 同意更新 |
| updateScore() | スコア更新 |

---

## SegmentAggregate セグメント集約

| 項目 | 値 |
|------|-----|
| 日本語名 | セグメント集約 |
| ルートエンティティ | Segment |

### 説明

セグメントとそのメンバーシップを管理する集約。

### 含むエンティティ

| エンティティ | 関係 | 説明 |
|--------------|------|------|
| Segment | Root | セグメント（ルート） |

### 含む値オブジェクト

| 値オブジェクト | 説明 |
|----------------|------|
| SegmentCondition[] | 抽出条件 |

### 整合性境界

```
┌─────────────────────────────────────────────────────────┐
│  SegmentAggregate                                       │
│  ┌───────────────────────────────────────────────────┐ │
│  │  Segment (Root)                                   │ │
│  │    └── SegmentCondition[]                         │ │
│  └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 不変条件

1. メンバー数が10人未満のセグメントは作成不可
2. 条件は論理的に矛盾しないこと
3. DYNAMIC型は更新スケジュール必須

### 操作

| 操作 | 説明 |
|------|------|
| createSegment() | セグメント作成 |
| updateConditions() | 条件更新 |
| refreshMembers() | メンバー再計算 |
| archive() | アーカイブ |

---

## JourneyAggregate ジャーニー集約

| 項目 | 値 |
|------|-----|
| 日本語名 | ジャーニー集約 |
| ルートエンティティ | Journey |

### 説明

カスタマージャーニーとその実行状態を管理する集約。

### 含むエンティティ

| エンティティ | 関係 | 説明 |
|--------------|------|------|
| Journey | Root | ジャーニー（ルート） |

### 含む値オブジェクト

| 値オブジェクト | 説明 |
|----------------|------|
| JourneyStep[] | ジャーニーステップ |
| JourneyStatistics | 実行統計 |

### 整合性境界

```
┌─────────────────────────────────────────────────────────┐
│  JourneyAggregate                                       │
│  ┌───────────────────────────────────────────────────┐ │
│  │  Journey (Root)                                   │ │
│  │    ├── JourneyStep[]                              │ │
│  │    └── JourneyStatistics                          │ │
│  └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 不変条件

1. 無限ループは検出・禁止
2. 終了条件は必須
3. 実行中ジャーニーの構造変更は不可

### 操作

| 操作 | 説明 |
|------|------|
| createJourney() | ジャーニー作成 |
| addStep() | ステップ追加 |
| validate() | 検証 |
| activate() | 有効化 |
| pause() | 一時停止 |
| complete() | 完了 |

---

**作成日**: 2025-12-05
**更新日**: 2025-12-05
